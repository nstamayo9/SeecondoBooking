<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout | CondoBook</title>
    
        <!-- ✅ FAVICON ADDED HERE -->
    <link rel="icon" type="image/png" href="/images/logo.png">
    <!-- Google Fonts: Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        :root {
            --primary-color: #4361ee;
            --secondary-color: #3f37c9;
            --bg-light: #f8f9fa;
            --text-dark: #1f2937;
            --card-radius: 16px;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-light);
            color: var(--text-dark);
        }

        .card {
            border: none;
            border-radius: var(--card-radius);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: all 0.3s ease;
        }

        .card-header {
            background-color: white;
            border-bottom: 1px solid #f3f4f6;
            padding: 1.5rem;
            border-radius: var(--card-radius) var(--card-radius) 0 0 !important;
        }

        .form-control, .form-select {
            border-radius: 8px;
            padding: 0.6rem 1rem;
            border: 1px solid #e5e7eb;
            font-size: 0.95rem;
        }

        .form-control:focus, .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 4px rgba(67, 97, 238, 0.15);
        }

        .btn-primary {
            background-color: var(--primary-color);
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
        }

        .btn-primary:hover {
            background-color: var(--secondary-color);
        }

        .summary-card {
            position: sticky;
            top: 20px; /* Stick to top when scrolling */
        }

        .room-img {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 12px;
        }

        .xs-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #6b7280;
            font-weight: 600;
            margin-bottom: 0.25rem;
            display: block;
        }
    </style>
</head>
<body>

    <div class="container py-5">
        <div class="row g-4">
            
            <!-- LEFT COLUMN: BOOKING SUMMARY (Sticky) -->
            <div class="col-lg-4 order-lg-2">
                <div class="card summary-card">
                    <div class="card-header">
                        <h5 class="mb-0 fw-bold">Booking Summary</h5>
                    </div>
                    <div class="card-body p-4">
                        
                        <!-- Room Info -->
                        <div class="d-flex align-items-center mb-4">
                            <img src="<%= room.images[0] %>" class="room-img me-3 shadow-sm">
                            <div>
                                <h6 class="mb-1 fw-bold text-dark"><%= room.name %></h6>
                                <span class="badge bg-light text-dark border"><%= room.category %></span>
                            </div>
                        </div>

                        <!-- Dates -->
                        <div class="bg-light p-3 rounded mb-4">
                            <div class="row g-2">
                                <div class="col-6 border-end">
                                    <span class="xs-label">Check-in</span>
                                    <div class="fw-bold text-dark"><%= new Date(bookingData.checkIn).toLocaleDateString() %></div>
                                    <small class="text-muted"><%= new Date(bookingData.checkIn).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) %></small>
                                </div>
                                <div class="col-6 ps-3">
                                    <span class="xs-label">Check-out</span>
                                    <div class="fw-bold text-dark"><%= new Date(bookingData.checkOut).toLocaleDateString() %></div>
                                    <small class="text-muted"><%= new Date(bookingData.checkOut).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) %></small>
                                </div>
                            </div>
                        </div>

                        <!-- Price Breakdown -->
                        <div class="mb-3">
                            <div class="d-flex justify-content-between mb-2 small">
                                <span class="text-muted">₱<%= room.pricePerNight.toLocaleString() %> x <%= bookingData.nights %> nights</span>
                                <span class="fw-bold">₱<%= (room.pricePerNight * bookingData.nights).toLocaleString() %></span>
                            </div>
                            
                            <% if (bookingData.extraFee > 0) { %>
                                <div class="d-flex justify-content-between mb-2 small text-warning">
                                    <span class="fw-bold"><i class="fas fa-clock me-1"></i> Early/Late Fees</span>
                                    <span class="fw-bold">+ ₱<%= bookingData.extraFee.toLocaleString() %></span>
                                </div>
                            <% } %>

                            <div class="d-flex justify-content-between mb-2 small text-success" id="discountRow" style="display: none !important;">
                                <span class="fw-bold">Promo Discount</span>
                                <span class="fw-bold">- ₱<span id="discountDisplay">0</span></span>
                            </div>
                        </div>

                        <hr class="my-3">

                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <span class="fw-bold text-secondary">Total Price</span>
                            <span class="fs-3 fw-bold text-primary">₱<span id="totalDisplay"><%= bookingData.totalPrice.toLocaleString() %></span></span>
                        </div>

                        <!-- Promo Code -->
                        <div class="mb-3">
                            <label class="xs-label">Have a Promo Code?</label>
                            <div class="input-group">
                                <input type="text" id="promoCodeInput" class="form-control" placeholder="Enter Code">
                                <button class="btn btn-dark" type="button" onclick="applyPromo()">Apply</button>
                            </div>
                            <div id="promoMessage" class="small mt-2 fw-bold" style="min-height: 20px;"></div>
                        </div>

                    </div>
                </div>
            </div>

            <!-- RIGHT COLUMN: GUEST DETAILS FORM -->
            <div class="col-lg-8 order-lg-1">
                <form action="/booking/confirm" method="POST" enctype="multipart/form-data" onsubmit="return validateCapacity()">
                    
                    <!-- Hidden Fields -->
                    <input type="hidden" name="roomId" value="<%= room._id %>">
                    <input type="hidden" name="checkIn" value="<%= bookingData.checkIn %>">
                    <input type="hidden" name="checkOut" value="<%= bookingData.checkOut %>">
                    <input type="hidden" name="finalPrice" id="finalPriceInput" value="<%= bookingData.totalPrice %>">
                    <input type="hidden" name="promoId" id="promoIdInput" value="">
                    <input type="hidden" name="extraFee" value="<%= bookingData.extraFee || 0 %>">

                    <!-- 1. GUEST COUNT -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0 fw-bold text-primary"><i class="fas fa-users me-2"></i> Guest Configuration</h5>
                        </div>
                        <div class="card-body p-4">
                            <div class="alert alert-info d-flex align-items-center mb-4">
                                <i class="fas fa-info-circle fa-lg me-3"></i>
                                <div>
                                    <strong>Capacity Note:</strong> Infants (0-1 yr) are free and do not count towards the room limit.
                                </div>
                            </div>
                            
                            <label class="form-label fw-bold">How many people are staying?</label>
                            <select id="totalGuests" name="guests" class="form-select form-select-lg mb-2" onchange="renderCompanionForms()">
                                <% 
                                    // Allow selecting more than capacity to account for infants
                                    const maxSelectable = room.capacity + 3; 
                                %>
                                <% for(let i=1; i<=maxSelectable; i++) { %>
                                    <option value="<%= i %>" <%= i == bookingData.guests ? 'selected' : '' %>>
                                        <%= i %> <%= i === 1 ? 'Person' : 'People' %>
                                    </option>
                                <% } %>
                            </select>
                            <div class="text-muted small">Max standard capacity: <%= room.capacity %> guests.</div>
                        </div>
                    </div>

                    <!-- 2. PRIMARY GUEST -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0 fw-bold text-dark"><i class="fas fa-user-circle me-2"></i> Primary Guest</h5>
                        </div>
                        <div class="card-body p-4">
                            <div class="row g-3 mb-3">
                                <div class="col-md-4">
                                    <label class="xs-label">First Name</label>
                                    <input type="text" name="firstName" class="form-control" value="<%= user.firstName || '' %>" required>
                                </div>
                                <div class="col-md-4">
                                    <label class="xs-label">Middle Name</label>
                                    <input type="text" name="middleName" class="form-control" value="<%= user.middleName || '' %>" placeholder="Optional">
                                </div>
                                <div class="col-md-4">
                                    <label class="xs-label">Last Name</label>
                                    <input type="text" name="lastName" class="form-control" value="<%= user.lastName || '' %>" required>
                                </div>
                            </div>

                            <div class="row g-3 mb-4">
                                <div class="col-md-6">
                                    <label class="xs-label">Date of Birth</label>
                                    <input type="date" name="guestDateOfBirth" class="form-control" value="<%= user.dateOfBirth ? new Date(user.dateOfBirth).toISOString().split('T')[0] : '' %>" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="xs-label">Phone Number</label>
                                    <input type="text" name="guestPhone" class="form-control" required placeholder="0917-XXX-XXXX">
                                </div>
                            </div>

                            <div class="mb-4">
                                <label class="xs-label text-primary">Upload Valid ID</label>
                                <input type="file" name="primaryIdImage" class="form-control" accept="image/*" required>
                                <div class="form-text">Government issued ID required for verification.</div>
                            </div>
                            
                            <div>
                                <label class="xs-label">Special Requests</label>
                                <textarea name="specialRequests" class="form-control" rows="2" placeholder="Any specific needs?"></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- 3. COMPANIONS -->
                    <div id="companionsSection" style="display: none;">
                        <h5 class="fw-bold text-secondary mb-3">Companion Details</h5>
                        <div id="companionsContainer"></div>
                    </div>
                    
                    <div class="card mb-4 border-warning bg-warning bg-opacity-10">
                        <div class="card-body">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="agreeCheck" required>
                                <label class="form-check-label small" for="agreeCheck">
                                    I have read and agree to the 
                                    <a href="/legal/terms" target="_blank" class="fw-bold text-decoration-underline">Terms & Conditions</a> 
                                    and 
                                    <a href="/legal/privacy" target="_blank" class="fw-bold text-decoration-underline">Privacy Policy</a>,  
                                    and I consent to the collection and processing of my personal data in accordance with the Data Privacy Act of 2012 (RA 10173). I certify that the ID uploaded is valid and belongs to the primary guest.
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- SUBMIT -->
                    <div class="d-grid gap-2 mt-5">
                        <button type="submit" class="btn btn-primary btn-lg shadow-sm py-3">
                            <i class="fas fa-check-circle me-2"></i> Confirm & Book Now
                        </button>
                        <a href="/room/<%= room._id %>" class="btn btn-outline-secondary">Cancel Booking</a>
                    </div>

                </form>
            </div>
        </div>
    </div>

<!-- SCRIPTS -->
<script>
    const originalTotal = <%= bookingData.totalPrice %>;
    const roomId = '<%= room._id %>';
    const checkInDateStr = '<%= bookingData.checkIn %>';
    const pricePerNight = <%= room.pricePerNight %>;
    const totalNights = <%= bookingData.nights %>;
    const maxCapacity = <%= room.capacity %>;

    document.addEventListener('DOMContentLoaded', function() {
        renderCompanionForms();
    });

    async function applyPromo() {
        const code = document.getElementById('promoCodeInput').value;
        const messageEl = document.getElementById('promoMessage');
        const userEmail = "<%= user.email %>"; 
        
        if(!code) {
            messageEl.innerHTML = '<span class="text-danger">Please enter a code.</span>';
            return;
        }

        try {
            const response = await fetch('/promo/validate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    code, 
                    roomId, 
                    totalAmount: originalTotal,
                    checkInDate: checkInDateStr,
                    pricePerNight: pricePerNight,
                    nights: totalNights,
                    email: userEmail
                })
            });

            const data = await response.json();

            if (data.success) {
                messageEl.innerHTML = `<span class="text-success"><i class="fas fa-check-circle"></i> ${data.message}</span>`;
                
                // Show Discount Row
                const row = document.getElementById('discountRow');
                row.style.display = 'flex';
                row.style.setProperty('display', 'flex', 'important');
                
                document.getElementById('discountDisplay').innerText = data.discountAmount.toLocaleString();
                document.getElementById('totalDisplay').innerText = (originalTotal - data.discountAmount).toLocaleString();
                
                // Update Hidden Inputs
                document.getElementById('finalPriceInput').value = (originalTotal - data.discountAmount);
                document.getElementById('promoIdInput').value = data.promoId;
                
                document.getElementById('promoCodeInput').disabled = true;
            } else {
                messageEl.innerHTML = `<span class="text-danger"><i class="fas fa-times-circle"></i> ${data.message}</span>`;
            }

        } catch (err) {
            console.error(err);
            messageEl.innerText = 'Error connecting to server.';
        }
    }

    function renderCompanionForms() {
        const totalGuests = parseInt(document.getElementById('totalGuests').value);
        const container = document.getElementById('companionsContainer');
        const section = document.getElementById('companionsSection');
        
        container.innerHTML = '';

        if (totalGuests === 1) {
            section.style.display = 'none';
            return;
        }

        section.style.display = 'block';
        const companionsNeeded = totalGuests - 1;

        for (let i = 1; i <= companionsNeeded; i++) {
            const div = document.createElement('div');
            div.className = 'card mb-3 border bg-white';
            div.innerHTML = `
                <div class="card-header bg-light py-2">
                    <small class="fw-bold text-uppercase text-muted">Companion #${i}</small>
                </div>
                <div class="card-body p-3">
                    <div class="row g-3 mb-3">
                        <div class="col-md-6">
                            <label class="xs-label">Full Name</label>
                            <input type="text" name="compName[]" class="form-control" required>
                        </div>
                        <div class="col-md-3">
                            <label class="xs-label">Date of Birth</label>
                            <input type="date" name="compDateOfBirth[]" class="form-control" required onchange="calculateAge(this)">
                        </div>
                        <div class="col-md-3">
                            <label class="xs-label">Age</label>
                            <input type="number" name="compAge[]" class="form-control comp-age bg-light" required readonly>
                        </div>
                    </div>
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="xs-label">Gender</label>
                            <select name="compGender[]" class="form-select">
                                <option>Male</option><option>Female</option><option>Other</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="xs-label">Contact</label>
                            <input type="text" name="compContact[]" class="form-control" required>
                        </div>
                        <div class="col-md-4">
                            <label class="xs-label">Upload ID</label>
                            <input type="file" name="compIdImage" class="form-control" accept="image/*" required>
                        </div>
                    </div>
                </div>
            `;
            container.appendChild(div);
        }
    }

    function calculateAge(dobInput) {
        const dob = new Date(dobInput.value);
        const ageInput = dobInput.closest('.card-body').querySelector('.comp-age');
        
        if (dob) {
            const today = new Date();
            let age = today.getFullYear() - dob.getFullYear();
            const m = today.getMonth() - dob.getMonth();
            if (m < 0 || (m === 0 && today.getDate() < dob.getDate())) {
                age--;
            }
            ageInput.value = age;
        }
    }

    function validateCapacity() {
        const ageInputs = document.querySelectorAll('.comp-age');
        let countableGuests = 1; // Primary Guest is assumed Adult

        ageInputs.forEach(input => {
            const age = parseInt(input.value);
            // If age is valid and >= 2, count it.
            if (!isNaN(age) && age >= 2) { 
                countableGuests++;
            }
            // If user hasn't filled DOB yet, we can't validate, but 'required' attribute handles empty fields.
        });

        if (countableGuests > maxCapacity) {
            alert(`Room Capacity Exceeded!\n\nMax Standard Capacity: ${maxCapacity}\nYour Countable Guests (Age 2+): ${countableGuests}\n\nNote: Infants (0-1yr) are free and do not count towards the limit.\n\nPlease reduce the number of guests or choose a larger room.`);
            return false;
        }
        return true;
    }
</script>
</body>
</html>