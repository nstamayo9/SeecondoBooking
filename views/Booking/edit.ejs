<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Booking | See Condo</title>
            <!-- âœ… FAVICON ADDED HERE -->
    <link rel="icon" type="image/png" href="/images/logo.png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="bg-light">

    <%- include('../partials/navbar') %>

    <div class="container mt-5 mb-5">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="card shadow border-0">
                    <div class="card-header bg-dark text-white py-3">
                        <h4 class="mb-0 fw-bold"><i class="fas fa-edit me-2"></i> Edit Booking Details</h4>
                    </div>
                    <div class="card-body p-4">
                        
                        <!-- Booking Summary -->
                        <div class="alert alert-secondary small mb-4">
                            <div class="row">
                                <div class="col-6"><strong>Room:</strong> <%= room.name %> (Max: <%= room.capacity %>)</div>
                                <div class="col-6 text-end"><strong>Dates:</strong> <%= new Date(booking.checkInDate).toLocaleDateString() %> - <%= new Date(booking.checkOutDate).toLocaleDateString() %></div>
                            </div>
                        </div>

                        <form id="editBookingForm" action="/booking/edit/<%= booking._id %>" method="POST" enctype="multipart/form-data" onsubmit="return validateCapacity()">
                            
                            <!-- 1. GUEST COUNT SELECTION -->
                            <div class="card mb-4 border-primary shadow-sm">
                                <div class="card-header bg-primary text-white">
                                    <h6 class="mb-0"><i class="fas fa-users me-2"></i> Total Guests</h6>
                                </div>
                                <div class="card-body">
                                    <label class="form-label fw-bold">How many people in total?</label>
                                    <div class="text-muted small mb-2">
                                        <i class="fas fa-info-circle"></i> Infants (0-1 yr) are free and do not count towards the room limit.
                                    </div>
                                    
                                    <!-- Allow selection beyond capacity to accommodate infants -->
                                    <select id="totalGuests" name="guests" class="form-select form-select-lg" onchange="renderCompanionForms()">
                                        <% 
                                            // Allow selection up to Capacity + 2 (for infants)
                                            const maxSelectable = room.capacity + 2; 
                                            const currentTotal = booking.companions.length + 1;
                                        %>
                                        <% for(let i=1; i<=maxSelectable; i++) { %>
                                            <option value="<%= i %>" <%= currentTotal == i ? 'selected' : '' %>>
                                                <%= i %> <%= i === 1 ? 'Person' : 'People' %>
                                                <%= i > room.capacity ? '(Only if extras are infants)' : '' %>
                                            </option>
                                        <% } %>
                                    </select>
                                </div>
                            </div>

                            <!-- 2. PRIMARY GUEST -->
                            <div class="card mb-4 border-0 shadow-sm">
                                <div class="card-header bg-light fw-bold">Primary Guest (You)</div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label small fw-bold">Phone Number</label>
                                            <input type="text" name="guestPhone" class="form-control" value="<%= booking.guestPhone %>" required>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label small fw-bold">Date of Birth</label>
                                            <!-- Assuming user DOB is stored, if not, allow input -->
                                            <input type="date" name="guestDateOfBirth" class="form-control" 
                                                   value="<%= booking.user.dateOfBirth ? new Date(booking.user.dateOfBirth).toISOString().split('T')[0] : '' %>" required>
                                        </div>
                                        <div class="col-md-12 mb-3">
                                            <label class="form-label small fw-bold">Update ID Image</label>
                                            <input type="file" name="primaryIdImage" class="form-control" accept="image/*">
                                            <% if(booking.guestIdImage) { %>
                                                <small class="text-muted">Current: <a href="<%= booking.guestIdImage %>" target="_blank">View ID</a></small>
                                            <% } %>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label small fw-bold">Special Requests</label>
                                        <textarea name="specialRequests" class="form-control" rows="2"><%= booking.specialRequests %></textarea>
                                    </div>
                                </div>
                            </div>

                            <!-- 3. COMPANIONS SECTION -->
                            <div id="companionsSection" style="display: none;">
                                <h5 class="text-primary mb-3 border-bottom pb-2">Companion Details</h5>
                                <div id="companionsContainer">
                                    <!-- JavaScript will inject companion cards here -->
                                </div>
                            </div>

                            <div class="d-grid gap-2 mt-5">
                                <button type="submit" class="btn btn-success btn-lg fw-bold">
                                    <i class="fas fa-save me-2"></i> Save Changes
                                </button>
                                <a href="/dashboard" class="btn btn-outline-secondary">Cancel</a>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script>
    // 1. Load existing companions from MongoDB into a JS Array
    const existingCompanions = <%- JSON.stringify(booking.companions || []) %>;
    const maxCapacity = <%= room.capacity %>;

    // 2. Run the renderer when the page finishes loading
    document.addEventListener('DOMContentLoaded', function() {
        renderCompanionForms();
    });

    // 3. The Core Logic Function
    function renderCompanionForms() {
        const totalGuests = parseInt(document.getElementById('totalGuests').value);
        const container = document.getElementById('companionsContainer');
        const section = document.getElementById('companionsSection');
        
        // Clear container but try to preserve entered values if re-rendering (advanced, but simple clear is safer)
        container.innerHTML = '';

        if (totalGuests <= 1) {
            section.style.display = 'none';
            return;
        }

        section.style.display = 'block';
        const companionsNeeded = totalGuests - 1;

        for (let i = 0; i < companionsNeeded; i++) {
            const data = existingCompanions[i] || { name: '', age: '', dateOfBirth: '', gender: 'Male', contact: '', idImage: '' };
            
            // Format existing DOB for input date (YYYY-MM-DD)
            let dobValue = '';
            if (data.dateOfBirth) {
                dobValue = new Date(data.dateOfBirth).toISOString().split('T')[0];
            }

            const div = document.createElement('div');
            div.className = 'card p-3 mb-3 bg-white border shadow-sm companion-card';
            div.innerHTML = `
                <h6 class="text-secondary fw-bold border-bottom pb-2 mb-3">Companion #${i + 1}</h6>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="small fw-bold">Full Name</label>
                        <input type="text" name="compName[]" class="form-control" value="${data.name}" required>
                    </div>
                    
                    <!-- AGE & DOB -->
                    <div class="col-md-3 mb-3">
                        <label class="small fw-bold">Date of Birth</label>
                        <input type="date" name="compDateOfBirth[]" class="form-control comp-dob" value="${dobValue}" required onchange="calculateAge(this)">
                    </div>
                    <div class="col-md-3 mb-3">
                        <label class="small fw-bold">Age</label>
                        <input type="number" name="compAge[]" class="form-control comp-age" value="${data.age}" readonly>
                    </div>

                    <div class="col-md-3 mb-3">
                        <label class="small fw-bold">Gender</label>
                        <select name="compGender[]" class="form-select">
                            <option value="Male" ${data.gender === 'Male' ? 'selected' : ''}>Male</option>
                            <option value="Female" ${data.gender === 'Female' ? 'selected' : ''}>Female</option>
                        </select>
                    </div>
                    <div class="col-md-9 mb-3">
                        <label class="small fw-bold">Update ID Image (Optional)</label>
                        <input type="file" name="compIdImage" class="form-control" accept="image/*">
                        ${data.idImage ? `<small class="text-muted">Current: <a href="${data.idImage}" target="_blank">View ID</a></small>` : ''}
                    </div>
                </div>
            `;
            container.appendChild(div);
        }
    }

    // 4. Auto-Calculate Age from DOB
    function calculateAge(dobInput) {
        const dob = new Date(dobInput.value);
        const ageInput = dobInput.closest('.row').querySelector('.comp-age');
        
        if (dob) {
            const diffMs = Date.now() - dob.getTime();
            const ageDate = new Date(diffMs);
            const age = Math.abs(ageDate.getUTCFullYear() - 1970);
            ageInput.value = age;
        }
    }

    // 5. Validate Capacity on Submit
    function validateCapacity() {
        const ageInputs = document.querySelectorAll('.comp-age');
        let countableGuests = 1; // Primary Guest is always counted

        ageInputs.forEach(input => {
            const age = parseInt(input.value) || 0;
            if (age >= 2) { // Only count if 2 years or older
                countableGuests++;
            }
        });

        if (countableGuests > maxCapacity) {
            alert(`Room Capacity Exceeded!\n\nMax Capacity: ${maxCapacity}\nCountable Guests (Age 2+): ${countableGuests}\n\nInfants (0-1yr) are free and not counted.\nPlease reduce the number of guests or remove non-infants.`);
            return false; // Stop submission
        }
        return true; // Allow submission
    }
</script>
</body>
</html>