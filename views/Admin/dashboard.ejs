<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | See Condo</title>
    
        <!-- ‚úÖ FAVICON ADDED HERE -->
    <link rel="icon" type="image/png" href="/images/logo.png">
    <!-- Google Fonts: Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Flatpickr CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <!-- FullCalendar JS -->
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
    
    <style>
        :root {
            --primary-color: #4361ee;
            --secondary-color: #3f37c9;
            --bg-light: #f3f4f6;
            --text-dark: #1f2937;
            --text-muted: #6b7280;
            --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-light);
            color: var(--text-dark);
        }

        /* --- Navbar --- */
        .navbar {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding-top: 0.75rem;
            padding-bottom: 0.75rem;
        }
        .navbar-brand { font-weight: 700; letter-spacing: -0.5px; }

        /* --- Cards & Containers --- */
        .card {
            border: none;
            border-radius: 12px;
            box-shadow: var(--card-shadow);
            transition: transform 0.2s ease;
            background: #fff;
        }
        .card-header {
            background-color: #fff;
            border-bottom: 1px solid #f0f0f0;
            border-radius: 12px 12px 0 0 !important;
            padding: 1.25rem;
        }
        
        /* --- Sidebar Buttons --- */
        .dash-btn {
            text-align: left;
            padding: 12px 15px;
            border-radius: 8px;
            background: white;
            border: 1px solid #e5e7eb;
            color: var(--text-dark);
            font-weight: 500;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            width: 100%;
            margin-bottom: 10px;
        }
        .dash-btn:hover {
            background: #eff6ff;
            border-color: var(--primary-color);
            color: var(--primary-color);
            transform: translateX(5px);
        }
        .dash-btn i { width: 25px; }

        /* --- Tables --- */
        .table thead th {
            background-color: #f9fafb;
            color: #6b7280;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.05em;
            border-bottom: 1px solid #e5e7eb;
        }
        .table td { vertical-align: middle; padding: 1rem 0.75rem; border-bottom: 1px solid #f3f4f6; }
        
        /* --- Badges --- */
        .badge { padding: 0.5em 0.8em; border-radius: 6px; font-weight: 600; letter-spacing: 0.3px; }
        .bg-success-soft { background-color: #dcfce7; color: #166534; }
        .bg-warning-soft { background-color: #fef9c3; color: #854d0e; }
        .bg-danger-soft { background-color: #fee2e2; color: #991b1b; }
        .bg-info-soft { background-color: #dbeafe; color: #1e40af; }

        /* --- Forms --- */
        .form-control, .form-select {
            border-radius: 8px;
            border: 1px solid #d1d5db;
            padding: 0.5rem 0.75rem;
            font-size: 0.9rem;
        }
        .form-control:focus, .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.15);
        }
        
        /* Remove default validation icons inside inputs */
        .form-control.is-valid, .form-control.is-invalid {
            background-image: none !important;
            padding-right: 0.75rem !important;
        }

        .xs-label {
            font-size: 0.7rem;
            text-transform: uppercase;
            color: #6b7280;
            font-weight: 700;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
            display: block;
        }

        /* --- Modals --- */
        .modal-content { border-radius: 16px; border: none; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); }
        .modal-header { border-bottom: 1px solid #f3f4f6; padding: 1.5rem; }
        .modal-body { padding: 1.5rem; }
        .modal-footer { border-top: 1px solid #f3f4f6; padding: 1rem 1.5rem; }
        
        /* --- Companions --- */
        .companion-card {
            border: 1px solid #e5e7eb;
            background: #f9fafb;
            border-radius: 8px;
            transition: all 0.2s;
        }
        .companion-card:hover { border-color: #d1d5db; background: #fff; }

        /* --- Calendar Fixes --- */
        #calendarModal { z-index: 1060 !important; }
        .fc { background: white; font-family: 'Inter', sans-serif; }
        .fc-header-toolbar { padding: 15px; }
        .fc-button-primary { background-color: var(--primary-color) !important; border: none !important; }

        /* --- Animations --- */
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.4); }
            70% { box-shadow: 0 0 0 6px rgba(220, 53, 69, 0); }
            100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0); }
        }
        .pulse-badge {
            animation: pulse-red 2s infinite;
        }
    </style>
</head>
<body>

    <!-- ==========================
         1. ADMIN NAVBAR
    =========================== -->
    <nav class="navbar navbar-expand-lg navbar-dark sticky-top">
        <div class="container-fluid px-4">
            <div class="d-flex align-items-center">
                <button class="btn btn-outline-light me-3 border-0 rounded-circle p-2" type="button" data-bs-toggle="offcanvas" data-bs-target="#adminSidebar">
                    <i class="fas fa-bars"></i>
                </button>
                <a class="navbar-brand d-flex align-items-center" href="/admin"> 
                    <i class="fas fa-user-shield me-2 text-info"></i> <span>Admin Panel</span>
                </a>
                <a href="#" class="nav-link text-white-50 ms-4 hover-white" data-bs-toggle="modal" data-bs-target="#calendarModal">
                    <i class="fas fa-calendar-alt me-1"></i> Master Calendar
                </a>
            </div>
            <div class="d-flex align-items-center">
                <div class="text-white me-3 d-none d-md-block text-end">
                    <div class="small text-white-50">Welcome back,</div>
                    <div class="fw-bold"><%= user.firstName %></div>
                </div>
                <a href="/" class="btn btn-light btn-sm rounded-pill px-3 fw-bold">Back to Site</a>
            </div>
        </div>
    </nav>

    <!-- ==========================
         2. SIDEBAR
    =========================== -->
    <div class="offcanvas offcanvas-start" tabindex="-1" id="adminSidebar" style="width: 300px;">
        <div class="offcanvas-header">
            <h5 class="offcanvas-title fw-bold"><i class="fas fa-cogs me-2"></i>Administration</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas"></button>
        </div>
        <div class="offcanvas-body bg-light p-3">
            
            <% if (['admin', 'superadmin'].includes(user.role)) { %>
                <button class="dash-btn" data-bs-toggle="modal" data-bs-target="#siteConfigModal">
                    <i class="fas fa-sliders-h text-primary"></i> Site Configuration
                </button>
            <% } %>

            <% if (['manager', 'admin', 'superadmin'].includes(user.role)) { %>
                <button class="dash-btn" data-bs-toggle="modal" data-bs-target="#amenitiesModal">
                    <i class="fas fa-swimming-pool text-info"></i> Resort Amenities
                </button>
                <button class="dash-btn" data-bs-toggle="modal" data-bs-target="#roomManagerModal">
                    <i class="fas fa-bed text-secondary"></i> Room Management
                </button>
                <button class="dash-btn" data-bs-toggle="modal" data-bs-target="#promoManagerModal">
                    <i class="fas fa-tags text-success"></i> Promo Manager
                </button>
            <% } %>

            <% if (['admin', 'superadmin'].includes(user.role)) { %>
                <button class="dash-btn" data-bs-toggle="modal" data-bs-target="#userManagerModal">
                    <i class="fas fa-users text-warning"></i> User Manager
                </button>
                <button class="dash-btn" data-bs-toggle="modal" data-bs-target="#createStaffModal">
                    <i class="fas fa-user-plus text-danger"></i> Create Staff Account
                </button>
            <% } %>
            
            <% if (['manager', 'admin', 'superadmin'].includes(user.role)) { %>
                <a href="/admin/analytics" class="dash-btn text-decoration-none">
                    <i class="fas fa-chart-pie text-purple me-2" style="color: #6f42c1;"></i> Analytics & Charts
                </a>
            <% } %>
            
            <% if (['manager', 'admin', 'superadmin'].includes(user.role)) { %>
                <button class="dash-btn" data-bs-toggle="modal" data-bs-target="#maintenanceModal">
                <i class="fas fa-tools text-danger"></i> Maintenance Tracker
            </button>
            <% } %>
            
            <button class="dash-btn" data-bs-toggle="modal" data-bs-target="#reviewModal">
            <i class="fas fa-star-half-alt text-warning"></i> Review Moderation
            <% if(typeof pendingReviews !== 'undefined' && pendingReviews.length > 0) { %>
            <span class="badge bg-danger ms-auto"><%= pendingReviews.length %></span>
            <% } %>
</button>
            
        </div>
    </div>

    <!-- ==========================
         3. MAIN DASHBOARD CONTENT
    =========================== -->
    <div class="container mt-5 mb-5">
        
        <!-- FINANCIAL REPORTS -->
        <% if (['manager', 'admin', 'superadmin'].includes(user.role)) { %>
        <div class="card mb-4">
            <div class="card-header d-flex align-items-center">
                <div class="bg-primary bg-opacity-10 p-2 rounded me-3 text-primary">
                    <i class="fas fa-chart-line fa-lg"></i>
                </div>
                <h5 class="mb-0 fw-bold">Financial Reports</h5>
            </div>
            <div class="card-body">
                <form action="/admin/report/download" method="GET" class="row align-items-end g-3">
                    <div class="col-md-3">
                        <label class="xs-label">Report Type</label>
                        <select name="filterBy" class="form-select">
                            <option value="checkin_date">Occupancy (Check-In Date)</option>
                            <option value="booking_date">Sales (Booking Date)</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="xs-label">Date Range</label>
                        <input type="text" id="reportDateRange" name="dateRange" class="form-control bg-white" placeholder="Select Start to End Date" required>
                    </div>
                    <div class="col-md-5">
                        <label class="xs-label">Export Format</label>
                        <div class="d-flex gap-2">
                            <button type="submit" name="format" value="csv" class="btn btn-success w-100 fw-bold"><i class="fas fa-file-csv me-2"></i> CSV</button>
                            <button type="submit" name="format" value="pdf" class="btn btn-danger w-100 fw-bold"><i class="fas fa-file-pdf me-2"></i> PDF</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
        <% } %>

         <!-- STATS CARDS -->
                <div class="row mb-4 g-4">
                    
                    <!-- CARD 1: CASH ON HAND (Actual Revenue) -->
                    <div class="col-md-4">
                        <div class="card h-100 border-start border-4 border-success">
                            <div class="card-body d-flex align-items-center justify-content-between">
                                <div>
                                    <div class="text-muted small text-uppercase fw-bold mb-1">Cash Collected</div>
                                    <div class="fs-2 fw-bold text-success">‚Ç±<%= stats.cashCollected.toLocaleString() %></div>
                                    <small class="text-muted">Actual money received</small>
                                </div>
                                <div class="bg-success-soft p-3 rounded-circle">
                                    <i class="fas fa-wallet fa-2x text-success"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- CARD 2: COLLECTIBLES (Balance Due) -->
                    <div class="col-md-4">
                        <div class="card h-100 border-start border-4 border-danger">
                            <div class="card-body d-flex align-items-center justify-content-between">
                                <div>
                                    <div class="text-muted small text-uppercase fw-bold mb-1">Collectibles</div>
                                    <div class="fs-2 fw-bold text-danger">‚Ç±<%= stats.receivables.toLocaleString() %></div>
                                    <small class="text-muted">Pending balances</small>
                                </div>
                                <div class="bg-danger-soft p-3 rounded-circle">
                                    <i class="fas fa-hand-holding-usd fa-2x text-danger"></i>
                                </div>
                            </div>
                        </div>
                    </div>

            <!-- CARD 3: TOTAL SALES (Gross Value) -->
            <div class="col-md-4">
                <div class="card h-100 border-start border-4 border-primary">
                    <div class="card-body d-flex align-items-center justify-content-between">
                        <div>
                            <div class="text-muted small text-uppercase fw-bold mb-1">Total Sales Value</div>
                            <div class="fs-2 fw-bold text-primary">‚Ç±<%= stats.totalSales.toLocaleString() %></div>
                            <small class="text-muted"><%= activeCount %> Active Bookings</small>
                        </div>
                        <div class="bg-primary-soft p-3 rounded-circle">
                            <i class="fas fa-chart-line fa-2x text-primary"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- BOOKING TABLE -->
        <div class="card mb-5">
            <div class="card-header bg-white py-3">
                <div class="row align-items-center">
                    <div class="col-md-3">
                        <h5 class="mb-0 fw-bold">Recent Bookings</h5>
                    </div>
                    <div class="col-md-9">
                        <form class="row g-2 justify-content-end" method="GET" action="/admin">
                            <div class="col-auto">
                                <input type="text" id="filterDateRange" name="dateRange" class="form-control form-control-sm bg-white" placeholder="Filter by Date" value="<%= typeof dateRange !== 'undefined' ? dateRange : '' %>">
                            </div>
                            <div class="col-auto">
                                <select class="form-select form-select-sm" name="status">
                                    <option value="">All Status</option>
                                    <option value="pending" <%= statusFilter==='pending'?'selected':'' %>>Pending</option>
                                    <option value="confirmed" <%= statusFilter==='confirmed'?'selected':'' %>>Confirmed</option>
                                    <option value="completed" <%= statusFilter==='completed'?'selected':'' %>>Completed</option>
                                    <option value="cancelled" <%= statusFilter==='cancelled'?'selected':'' %>>Cancelled</option>
                                </select>
                            </div>
                            <div class="col-auto">
                                <input class="form-control form-control-sm" type="search" name="search" placeholder="Name, Room, ID..." value="<%= search %>">
                            </div>
                            <div class="col-auto">
                                <button class="btn btn-sm btn-primary" type="submit"><i class="fas fa-search"></i></button>
                                <a href="/admin" class="btn btn-sm btn-outline-secondary"><i class="fas fa-undo"></i></a>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0 align-middle">
                        <thead>
                            <tr>
                                <th class="ps-4">ID</th>
                                <th>Guest Details</th>
                                <th>Room</th>
                                <th>Schedule</th>
                                <th>Status</th>
                                <th class="text-end pe-4">Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% if (bookings.length > 0) { %>
                                <% bookings.forEach(booking => { %>
                                    <tr>
                                        <td class="ps-4">
                                            <span class="font-monospace text-muted small">#<%= booking._id.toString().substring(0,6).toUpperCase() %></span>
                                        </td>
                                        <td>
                                            <div class="fw-bold text-dark"><%= booking.user ? booking.user.firstName : 'Unknown' %> <%= booking.user ? booking.user.lastName : '' %></div>
                                            <div class="small text-muted"><i class="fas fa-phone-alt me-1 fa-xs"></i><%= booking.guestPhone %></div>
                                        </td>
                                        <td>
                                            <span class="badge bg-light text-dark border fw-normal"><%= booking.room ? booking.room.name : 'Deleted Room' %></span>
                                        </td>
                                        <td>
                                            <div class="d-flex flex-column small">
                                                <span class="text-muted">In: <span class="fw-bold text-dark"><%= new Date(booking.checkInDate).toLocaleDateString() %></span></span>
                                                <span class="text-muted">Out: <span class="fw-bold text-dark"><%= new Date(booking.checkOutDate).toLocaleDateString() %></span></span>
                                            </div>
                                        </td>
                                        <td>
                                            <% 
                                                let statusClass = 'bg-secondary';
                                                if(booking.status === 'confirmed') statusClass = 'bg-warning-soft';
                                                else if(booking.status === 'completed') statusClass = 'bg-success-soft';
                                                else if(booking.status === 'cancelled') statusClass = 'bg-danger-soft';
                                                else if(booking.status === 'pending') statusClass = 'bg-info-soft';
                                            %>
                                            <span class="badge <%= statusClass %>"><%= booking.status.toUpperCase() %></span>

                                            <!-- 1-HOUR PAYMENT REMINDER LOGIC -->
                                            <% if(booking.status === 'pending' && booking.paymentStatus === 'unpaid') { 
                                                const oneHour = 60 * 60 * 1000;
                                                const createdTime = new Date(booking.createdAt).getTime();
                                                const nowTime = Date.now();
                                                let timeLeft = (createdTime + oneHour) - nowTime;
                                                if (timeLeft > 90 * 60 * 1000) { timeLeft -= 8 * 60 * 60 * 1000; }
                                                const minutesLeft = Math.floor(timeLeft / 60000);
                                            %>
                                                <% if(timeLeft > 0) { %>
                                                    <div class="mt-1">
                                                        <span class="badge bg-danger pulse-badge border border-light">
                                                            <i class="fas fa-stopwatch me-1"></i> Expires in <%= minutesLeft %>m
                                                        </span>
                                                    </div>
                                                <% } else { %>
                                                    <div class="mt-1">
                                                        <span class="badge bg-dark text-white border border-light">
                                                            <i class="fas fa-exclamation-triangle me-1"></i> EXPIRED
                                                        </span>
                                                    </div>
                                                <% } %>
                                            <% } %>
                                        </td>
                                        <td class="text-end pe-4">
                                            <button class="btn btn-sm btn-outline-primary rounded-pill px-3" data-bs-toggle="modal" data-bs-target="#modal-<%= booking._id.toString() %>">
                                                <i class="fas fa-cog me-1"></i> Manage
                                            </button>
                                        </td>
                                    </tr>
                                <% }) %>
                            <% } else { %> 
                                <tr><td colspan="6" class="text-center py-5 text-muted">No bookings found matching your criteria.</td></tr> 
                            <% } %>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="card-footer bg-white py-3">
                <nav>
                    <ul class="pagination justify-content-center mb-0">
                        <% for(let i=1; i<=totalPages; i++) { %>
                            <li class="page-item <%= currentPage == i ? 'active' : '' %>">
                                <a class="page-link rounded-circle mx-1" href="/admin?page=<%= i %>&search=<%= search %>&status=<%= statusFilter %>&dateRange=<%= typeof dateRange !== 'undefined' ? dateRange : '' %>"><%= i %></a>
                            </li>
                        <% } %>
                    </ul>
                </nav>
            </div>
        </div>
    </div>

    <!-- ==========================
         4. MODALS
    =========================== -->

<!-- 1. SITE CONFIG MODAL (TABS) -->
<div class="modal fade" id="siteConfigModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        
        <!-- ‚úÖ FIX: FORM TAG MOVED HERE (Wraps the modal-content) -->
        <form action="/admin/site-config/update" method="POST" enctype="multipart/form-data">
            
            <div class="modal-content">
                
                <!-- Header -->
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title fw-bold"><i class="fas fa-sliders-h me-2"></i> Site Configuration</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>

                <!-- Body (Scrollable) -->
                <div class="modal-body">
                    <!-- Nav Tabs -->
                    <ul class="nav nav-tabs mb-3 sticky-top bg-white pt-2" id="configTabs" role="tablist" style="z-index: 10;">
                        <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-home" type="button">üè† Home</button></li>
                        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-about" type="button">‚ÑπÔ∏è About</button></li>
                        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-ticket" type="button">üé´ Ticket</button></li>
                        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-social" type="button">üì± Socials</button></li>
                        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-legal" type="button">‚öñÔ∏è Legal</button></li>
                    </ul>

                    <div class="tab-content">
                        
                        <!-- HOME PAGE TAB -->
                        <div class="tab-pane fade show active" id="tab-home">
                            <div class="mb-3"><label class="xs-label">Hero Title</label><input type="text" name="heroTitle" class="form-control" value="<%= config.heroTitle %>"></div>
                            <div class="mb-3"><label class="xs-label">Hero Subtitle</label><input type="text" name="heroSubtitle" class="form-control" value="<%= config.heroSubtitle %>"></div>
                            <div class="mb-3"><label class="xs-label">Hero Description</label><textarea name="heroDescription" class="form-control" rows="3"><%= config.heroDescription %></textarea></div>
                            <div class="mb-3"><label class="xs-label">Customer Service #</label><input type="text" name="contactNumber" class="form-control" value="<%= config.contactNumber %>"></div>
                            <div class="row g-2 mb-3">
                                <div class="col-6"><label class="xs-label">Fee (Small Room)</label><input type="number" name="feeSmallRoom" class="form-control" value="<%= config.feeSmallRoom %>"></div>
                                <div class="col-6"><label class="xs-label">Fee (Large Room)</label><input type="number" name="feeLargeRoom" class="form-control" value="<%= config.feeLargeRoom %>"></div>
                            </div>
                            <div class="mb-3"><label class="xs-label">Background Images (Slider)</label><input type="file" name="heroImages" class="form-control" multiple accept="image/*"></div>
                        </div>

                        <!-- ABOUT US TAB -->
                        <div class="tab-pane fade" id="tab-about">
                            <div class="mb-3"><label class="xs-label">About Title</label><input type="text" name="aboutTitle" class="form-control" value="<%= config.aboutTitle %>"></div>
                            <div class="mb-3"><label class="xs-label">About Description</label><textarea name="aboutDescription" class="form-control" rows="5"><%= config.aboutDescription %></textarea></div>
                            <div class="mb-3"><label class="xs-label">About Image</label><input type="file" name="aboutImage" class="form-control" accept="image/*"></div>
                        </div>

                        <!-- TICKET INFO TAB -->
                        <div class="tab-pane fade" id="tab-ticket">
                            <div class="row g-3 mb-3">
                                <div class="col-6"><label class="xs-label">Owner Name</label><input type="text" name="ownerName" class="form-control" value="<%= config.ownerName %>"></div>
                                <div class="col-6"><label class="xs-label">Membership No.</label><input type="text" name="membershipNo" class="form-control" value="<%= config.membershipNo %>"></div>
                            </div>
                            <div class="row g-3 mb-3">
                                <div class="col-6"><label class="xs-label">Owner Email</label><input type="text" name="ownerEmail" class="form-control" value="<%= config.ownerEmail %>"></div>
                                <div class="col-6"><label class="xs-label">Owner Tel No.</label><input type="text" name="ownerTel" class="form-control" value="<%= config.ownerTel %>"></div>
                            </div>
                            <div class="mb-3"><label class="xs-label">Owner Address</label><input type="text" name="ownerAddress" class="form-control" value="<%= config.ownerAddress %>"></div>
                            <div class="mb-3"><label class="xs-label">Property Address (Header)</label><input type="text" name="propertyAddress" class="form-control" value="<%= config.propertyAddress %>"></div>
                            <div class="mb-3"><label class="xs-label">Property Tel No. (Header)</label><input type="text" name="propertyTel" class="form-control" value="<%= config.propertyTel %>"></div>
                        </div>

                        <!-- SOCIALS TAB -->
                        <div class="tab-pane fade" id="tab-social">
                            <div class="mb-3"><label class="xs-label">Facebook Link</label><input type="text" name="socialFacebook" class="form-control" value="<%= config.socialFacebook %>" placeholder="https://facebook.com/..."></div>
                            <div class="mb-3"><label class="xs-label">Viber Number</label><input type="text" name="socialViber" class="form-control" value="<%= config.socialViber %>" placeholder="+63..."></div>
                            <div class="mb-3"><label class="xs-label">Instagram Link</label><input type="text" name="socialInstagram" class="form-control" value="<%= config.socialInstagram %>" placeholder="https://Instagram.com/..."></div>
                            <div class="mb-3"><label class="xs-label">Tiktok Link</label><input type="text" name="socialTiktok" class="form-control" value="<%= config.socialTiktok %>" placeholder="https://Tiktok.com/@..."></div>
                            <div class="mb-3"><label class="xs-label">YouTube Video URL</label><input type="text" name="videoUrl" class="form-control" value="<%= config.videoUrl %>" placeholder="e.g. https://www.youtube.com/watch?v=..."></div>
                        </div>
                        
                        <!-- LEGAL TAB -->
                        <div class="tab-pane fade" id="tab-legal">
                            <div class="alert alert-info small py-2">
                                <i class="fas fa-info-circle me-1"></i> These texts appear on public legal pages.
                            </div>
                            <div class="mb-3">
                                <label class="xs-label">Terms & Conditions</label>
                                <textarea name="legalTerms" class="form-control" rows="6"><%= config.legalTerms %></textarea>
                            </div>
                            <div class="mb-3">
                                <label class="xs-label">Privacy Policy</label>
                                <textarea name="legalPrivacy" class="form-control" rows="6"><%= config.legalPrivacy %></textarea>
                            </div>
                        </div>

                    </div>
                </div>

                <!-- Footer (Fixed at Bottom) -->
                <div class="modal-footer bg-light">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary fw-bold">Save Configuration</button>
                </div>
            </div>
            
        </form> <!-- ‚úÖ FIX: FORM TAG CLOSES HERE -->
    </div>
</div>

    <!-- 2. RESORT AMENITIES MODAL -->
    <div class="modal fade" id="amenitiesModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-info text-white"><h5 class="modal-title fw-bold">Resort Amenities</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-7 border-end">
                            <h6 class="fw-bold mb-3">Existing Amenities</h6>
                            <% if (typeof resortAmenities !== 'undefined' && resortAmenities.length > 0) { %>
                                <div class="list-group">
                                    <% resortAmenities.forEach(amenity => { %>
                                        <div class="list-group-item d-flex justify-content-between align-items-center">
                                            <div class="d-flex align-items-center">
                                                <% if(amenity.images && amenity.images.length > 0) { %>
                                                    <img src="<%= amenity.images[0] %>" class="rounded me-3" style="width: 50px; height: 50px; object-fit: cover;">
                                                <% } %>
                                                <div>
                                                    <div class="fw-bold"><%= amenity.name %></div>
                                                    <div class="small text-muted"><%= amenity.images.length %> images</div>
                                                </div>
                                            </div>
                                            <a href="/admin/amenity/delete/<%= amenity._id %>" class="btn btn-outline-danger btn-sm" onclick="return confirm('Delete this amenity?')"><i class="fas fa-trash"></i></a>
                                        </div>
                                    <% }) %>
                                </div>
                            <% } else { %> <div class="alert alert-light text-center">No amenities found.</div> <% } %>
                        </div>
                        <div class="col-md-5">
                            <h6 class="fw-bold mb-3">Add New Amenity</h6>
                            <form action="/admin/amenity/create" method="POST" enctype="multipart/form-data">
                                <div class="mb-3"><label class="xs-label">Name</label><input type="text" name="name" class="form-control" required></div>
                                <div class="mb-3"><label class="xs-label">Description</label><textarea name="description" class="form-control" rows="3"></textarea></div>
                                <div class="mb-3"><label class="xs-label">Images (Max 10)</label><input type="file" name="images" class="form-control" multiple required accept="image/*"></div>
                                <button type="submit" class="btn btn-success w-100">Add Amenity</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 3. ROOM MANAGER MODAL -->
    <div class="modal fade" id="roomManagerModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header bg-dark text-white"><h5 class="modal-title fw-bold">Room Manager</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <div class="d-flex justify-content-end mb-3"><button class="btn btn-success fw-bold shadow-sm" data-bs-toggle="modal" data-bs-target="#addRoomModal"><i class="fas fa-plus me-2"></i>Add New Room</button></div>
                    <div class="table-responsive card shadow-sm">
                        <table class="table table-hover align-middle mb-0">
                            <thead><tr><th>Image</th><th>Name</th><th>Capacity</th><th>Category</th><th>Price</th><th>Action</th></tr></thead>
                            <tbody>
                                <% rooms.forEach(room => { %>
                                    <tr>
                                        <td><img src="<%= room.images[0] || '' %>" class="rounded" style="width: 60px; height: 40px; object-fit: cover;"></td>
                                        <td class="fw-bold"><%= room.name %></td>
                                        <td><%= room.capacity %></td>
                                        <td><span class="badge bg-secondary"><%= room.category %></span></td>
                                        <td class="text-success fw-bold">‚Ç±<%= room.pricePerNight.toLocaleString() %></td>
                                        <td>
                                            <button class="btn btn-sm btn-light border" data-bs-toggle="modal" data-bs-target="#editRoomModal-<%= room._id.toString() %>"><i class="fas fa-edit"></i></button>
                                            <a href="/admin/room/delete/<%= room._id %>" class="btn btn-sm btn-light border text-danger" onclick="return confirm('Delete this room?')"><i class="fas fa-trash"></i></a>
                                        </td>
                                    </tr>
                                <% }) %>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 4. PROMO MANAGER MODAL -->
    <div class="modal fade" id="promoManagerModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title fw-bold">Promotion Manager</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- CREATE FORM -->
                    <form action="/admin/promo/create" method="POST" class="mb-4 border-bottom pb-4">
                        <div class="row g-2 mb-2">
                            <div class="col-4"><input type="text" name="code" class="form-control" placeholder="Code (e.g. SUMMER20)" required></div>
                            <div class="col-8"><input type="text" name="name" class="form-control" placeholder="Promo Name" required></div>
                        </div>
                        <div class="row g-2 mb-2">
                            <div class="col-6">
                                <select name="type" class="form-select">
                                    <option value="percentage">% Off</option>
                                    <option value="fixed">Amount Less</option>
                                    <option value="extension">Time Extension</option>
                                </select>
                            </div>
                            <div class="col-6"><input type="number" name="value" class="form-control" placeholder="Value (e.g. 20)" required></div>
                        </div>
                        <div class="mb-3">
                            <input type="text" id="eligibleDatesInput" name="eligibleDates" class="form-control bg-white" placeholder="Select eligible dates..." readonly>
                        </div>
                        
                        <div class="mb-3">
                            <label class="xs-label">Restricted Emails (Optional)</label>
                            <input type="text" name="allowedEmails" class="form-control" placeholder="user@example.com, vip@gmail.com">
                            <small class="text-muted">Leave blank for public use. Comma separate for multiple.</small>
                        </div>
                        <button type="submit" class="btn btn-success w-100">Create Promo</button>
                    </form>

                    <!-- LIST -->
                    <h6 class="fw-bold mb-3">Active Promotions</h6>
                    <div class="table-responsive">
                        <table class="table align-middle">
                            <thead><tr><th>Code</th><th>Name</th><th>Value</th><th>Action</th></tr></thead>
                            <tbody>
                                <% promotions.forEach(p => { %>
                                    <tr>
                                        <td class="fw-bold text-success"><%= p.code %></td>
                                        <td><%= p.name %></td>
                                        <td>
                                            <% if(p.type === 'extension') { %>
                                                +<%= p.extensionHours %> hrs
                                            <% } else if(p.type === 'percentage') { %>
                                                <%= p.discountValue %>%
                                            <% } else { %>
                                                ‚Ç±<%= p.discountValue %>
                                            <% } %>
                                        </td>
                                        <td>
                                            <!-- EDIT BUTTON (Triggers new modal) -->
                                            <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#editPromoModal-<%= p._id %>">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            
                                            <a href="/admin/promo/delete/<%= p._id %>" class="btn btn-sm btn-outline-danger" onclick="return confirm('Delete?')">
                                                <i class="fas fa-trash"></i>
                                            </a>
                                        </td>
                                    </tr>
                                <% }) %>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
        <!-- 4.1 EDIT PROMO MODALS -->
    <% promotions.forEach(p => { %>
        <div class="modal fade" id="editPromoModal-<%= p._id %>" tabindex="-1" style="z-index: 1060;">
            <div class="modal-dialog">
                <div class="modal-content">
                    <form action="/admin/promo/update" method="POST">
                        <div class="modal-header bg-primary text-white">
                            <h5 class="modal-title fw-bold">Edit Promo: <%= p.code %></h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <input type="hidden" name="promoId" value="<%= p._id %>">
                            
                            <div class="mb-3">
                                <label class="xs-label">Promo Code</label>
                                <input type="text" name="code" class="form-control" value="<%= p.code %>" required>
                            </div>
                            
                            <div class="mb-3">
                                <label class="xs-label">Name</label>
                                <input type="text" name="name" class="form-control" value="<%= p.name %>" required>
                            </div>

                            <div class="row g-2 mb-3">
                                <div class="col-6">
                                    <label class="xs-label">Type</label>
                                    <select name="type" class="form-select">
                                        <option value="percentage" <%= p.type === 'percentage' ? 'selected' : '' %>>% Off</option>
                                        <option value="fixed" <%= p.type === 'fixed' ? 'selected' : '' %>>Amount Less</option>
                                        <option value="extension" <%= p.type === 'extension' ? 'selected' : '' %>>Time Extension</option>
                                    </select>
                                </div>
                                <div class="col-6">
                                    <label class="xs-label">Value</label>
                                    <input type="number" name="value" class="form-control" value="<%= p.discountValue || p.extensionHours %>" required>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="xs-label">Eligible Dates</label>
                                <!-- Unique ID for Flatpickr -->
                                <input type="text" id="editDates-<%= p._id %>" name="eligibleDates" class="form-control bg-white" value="<%= p.eligibleDates.join(', ') %>" placeholder="Select dates..." readonly>
                            </div>
                            
                            <div class="mb-3">
                                <label class="xs-label">Restricted Emails</label>
                                <input type="text" name="allowedEmails" class="form-control" value="<%= p.allowedEmails ? p.allowedEmails.join(', ') : '' %>" placeholder="user@example.com">
                            </div>
                        </div>
                        <div class="modal-footer">
                            <!-- Button to go back to main list -->
                            <button type="button" class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#promoManagerModal">Back to List</button>
                            <button type="submit" class="btn btn-primary fw-bold">Save Changes</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    <% }) %>
    <!-- 5. USER MANAGER MODAL -->
    <div class="modal fade" id="userManagerModal" tabindex="-1">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header bg-secondary text-white"><h5 class="modal-title fw-bold">User Manager</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
    
                    <!-- TABS -->
                    <ul class="nav nav-tabs mb-3" id="userTabs" role="tablist">
                        <li class="nav-item">
                            <button class="nav-link active fw-bold text-primary" data-bs-toggle="tab" data-bs-target="#tab-staff" type="button">
                                <i class="fas fa-user-shield me-2"></i>Staff & Admins
                            </button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link fw-bold text-secondary" data-bs-toggle="tab" data-bs-target="#tab-guests" type="button">
                                <i class="fas fa-users me-2"></i>Guest List
                            </button>
                        </li>
                    </ul>

                    <div class="tab-content">
                        
                    <!-- TAB 1: STAFF MANAGEMENT -->
                    <div class="tab-pane fade show active" id="tab-staff">
                            <div class="alert alert-info small py-2"><i class="fas fa-info-circle me-1"></i> Managing internal staff accounts.</div>
                            <div class="table-responsive card shadow-sm">
                                <table class="table table-hover align-middle mb-0">
                                    <thead class="bg-light"><tr><th>Name</th><th>Role</th><th>Username</th><th>Action</th></tr></thead>
                                    <tbody>
                                        <% users.forEach(u => { %>
                                            <tr>
                                                <td class="fw-bold"><%= u.firstName %> <%= u.lastName %></td>
                                                <td>
                                                    <span class="badge bg-<%= u.role === 'superadmin' ? 'danger' : (u.role === 'admin' ? 'warning text-dark' : 'info') %>">
                                                        <%= u.role.toUpperCase() %>
                                                    </span>
                                                </td>
                                                <td><%= u.username %></td>
                                                <td>
                                                    <button class="btn btn-sm btn-light border" data-bs-toggle="modal" data-bs-target="#editUserModal-<%= u._id %>"><i class="fas fa-edit"></i></button>
                                                    <% if (u._id.toString() !== user._id.toString()) { %>
                                                        <a href="/admin/user/delete/<%= u._id %>" class="btn btn-sm btn-light border text-danger" onclick="return confirm('Delete staff?')"><i class="fas fa-trash"></i></a>
                                                    <% } %>
                                                </td>
                                            </tr>
                                        <% }) %>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- TAB 2: GUEST LIST -->
                        <div class="tab-pane fade" id="tab-guests">
                            <div class="alert alert-secondary small py-2"><i class="fas fa-info-circle me-1"></i> Registered guests (cannot access admin panel).</div>
                            <div class="table-responsive card shadow-sm">
                                <table class="table table-hover align-middle mb-0">
                                    <thead class="bg-light"><tr><th>Name</th><th>Email</th><th>Joined</th><th>Action</th></tr></thead>
                                    <tbody>
                                        <% if(typeof guestUsers !== 'undefined') { %>
                                            <% guestUsers.forEach(g => { %>
                                                <tr>
                                                    <td class="fw-bold"><%= g.firstName %> <%= g.lastName %></td>
                                                    <td><%= g.email %></td>
                                                    <td class="small text-muted"><%= new Date(g.createdAt).toLocaleDateString() %></td>
                                                    <td>
                                                        <button class="btn btn-sm btn-light border" data-bs-toggle="modal" data-bs-target="#editUserModal-<%= g._id %>"><i class="fas fa-edit"></i></button>
                                                        <a href="/admin/user/delete/<%= g._id %>" class="btn btn-sm btn-light border text-danger" onclick="return confirm('Delete guest account?')"><i class="fas fa-trash"></i></a>
                                                    </td>
                                                </tr>
                                            <% }) %>
                                        <% } %>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 6. CREATE STAFF MODAL -->
    <div class="modal fade" id="createStaffModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <form action="/admin/user/create" method="POST">
                    <div class="modal-header bg-warning text-dark"><h5 class="modal-title fw-bold">Create Staff Account</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                    <div class="modal-body">
                        <div class="row g-2 mb-3"><div class="col-6"><label class="xs-label">First Name</label><input type="text" name="firstName" class="form-control" required></div><div class="col-6"><label class="xs-label">Last Name</label><input type="text" name="lastName" class="form-control" required></div></div>
                        <div class="mb-3"><label class="xs-label">Username</label><input type="text" name="username" class="form-control" required></div>
                        <div class="mb-3"><label class="xs-label">Role</label><select name="role" class="form-select"><option value="staff">Staff</option><option value="manager">Manager</option><option value="admin">Admin</option><% if (user.role === 'superadmin') { %><option value="superadmin">Super Admin</option><% } %></select></div>
                        <div class="mb-3"><label class="xs-label">Password</label><input type="password" name="password" class="form-control" required autocomplete="current-password"></div>
                    </div>
                    <div class="modal-footer"><button type="submit" class="btn btn-warning fw-bold">Create Account</button></div>
                </form>
            </div>
        </div>
    </div>

    <!-- 7. ADD ROOM MODAL -->
    <div class="modal fade" id="addRoomModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <form action="/admin/room/create" method="POST" enctype="multipart/form-data">
                    <div class="modal-header bg-success text-white"><h5 class="modal-title">Add New Room</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                    <div class="modal-body">
                        <div class="mb-2"><label class="xs-label">Room Name</label><input type="text" name="name" class="form-control" required></div>
                        <div class="row g-2 mb-2">
                            <div class="col-6"><label class="xs-label">Price</label><input type="number" name="pricePerNight" class="form-control" required></div>
                            <div class="col-6"><label class="xs-label">Capacity</label><input type="number" name="capacity" class="form-control" required></div>
                        </div>
                        <div class="mb-2">
                            <label class="xs-label">Category</label>
                            <select name="category" class="form-select">
                                <option value="Studio">Studio</option>
                                <option value="1BR">1BR</option>
                                <option value="2BR">2BR</option>
                                <option value="3BR">3BR</option>
                                <option value="4BR">4BR</option>
                                <option value="Penthouse">Penthouse</option>
                            </select>
                        </div>
                        <div class="mb-2"><label class="xs-label">Amenities (comma separated)</label><input type="text" name="amenities" class="form-control" placeholder="Wifi, TV, AC..."></div>
                        <div class="mb-2"><label class="xs-label">Description</label><textarea name="description" class="form-control" required></textarea></div>
                        <div class="mb-2"><label class="xs-label">Images</label><input type="file" name="images" class="form-control" multiple required></div>
                    </div>
                    <div class="modal-footer"><button type="submit" class="btn btn-success">Create Room</button></div>
                </form>
            </div>
        </div>
    </div>

<!-- 8. EDIT ROOM MODALS -->
    <% rooms.forEach(room => { %>
        <div class="modal fade" id="editRoomModal-<%= room._id.toString() %>" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <form action="/admin/room/update" method="POST" enctype="multipart/form-data">
                        <div class="modal-header bg-warning-soft">
                            <h5 class="modal-title fw-bold text-dark">Edit Room: <%= room.name %></h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <input type="hidden" name="roomId" value="<%= room._id %>">
                            
                            <!-- Basic Details -->
                            <div class="row mb-3">
                                <div class="col-6">
                                    <label class="xs-label">Name</label>
                                    <input type="text" name="name" class="form-control" value="<%= room.name %>">
                                </div>
                                <div class="col-6">
                                    <label class="xs-label">Category</label>
                                    <select name="category" class="form-select">
                                        <option value="Studio" <%= room.category=='Studio'?'selected':'' %>>Studio</option>
                                        <option value="1BR" <%= room.category=='1BR'?'selected':'' %>>1BR</option>
                                        <option value="2BR" <%= room.category=='2BR'?'selected':'' %>>2BR</option>
                                        <option value="3BR" <%= room.category=='3BR'?'selected':'' %>>3BR</option>
                                        <option value="4BR" <%= room.category=='4BR'?'selected':'' %>>4BR</option>
                                        <option value="Penthouse" <%= room.category=='Penthouse'?'selected':'' %>>Penthouse</option>
                                    </select>
                                </div>
                            </div>

                            <div class="row mb-3">
                                <div class="col-6">
                                    <label class="xs-label">Price</label>
                                    <input type="number" name="pricePerNight" class="form-control" value="<%= room.pricePerNight %>">
                                </div>
                                <div class="col-6">
                                    <label class="xs-label">Capacity</label>
                                    <input type="number" name="capacity" class="form-control" value="<%= room.capacity %>">
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="xs-label">Description</label>
                                <textarea name="description" class="form-control" rows="3"><%= room.description %></textarea>
                            </div>

                            <div class="mb-3">
                                <label class="xs-label">Amenities</label>
                                <input type="text" name="amenities" class="form-control" value="<%= room.amenities.join(', ') %>">
                            </div>

                            <div class="mb-3">
                                <label class="xs-label text-primary">Update Images</label>
                                <input type="file" name="images" class="form-control" multiple accept="image/*">
                            </div>

                            <!-- ========================================== -->
                            <!-- NEW: CALENDAR SYNC SECTION                 -->
                            <!-- ========================================== -->
                            <div class="mb-3 border-top pt-3 bg-light p-3 rounded">
                                <h6 class="fw-bold text-primary small mb-3"><i class="fas fa-sync-alt me-2"></i> Calendar Sync (iCal)</h6>
                                
                                <!-- 1. PASTE LINKS HERE -->
                                <div class="mb-2">
                                    <label class="xs-label">Airbnb Export Link</label>
                                    <input type="text" name="airbnbIcalUrl" class="form-control form-control-sm" value="<%= room.airbnbIcalUrl || '' %>" placeholder="Paste Airbnb .ics link here...">
                                </div>
                                <div class="mb-3">
                                    <label class="xs-label">Agoda Export Link</label>
                                    <input type="text" name="agodaIcalUrl" class="form-control form-control-sm" value="<%= room.agodaIcalUrl || '' %>" placeholder="Paste Agoda .ics link here...">
                                </div>

                                <!-- 2. COPY LINK FROM HERE -->
                                <div class="mt-2 p-2 bg-white rounded border">
                                    <label class="xs-label text-success fw-bold">Your Export Link (Copy to Airbnb/Agoda):</label>
                                    <div class="input-group input-group-sm">
                                        <!-- Uses config.appUrl passed from controller -->
                                        <input type="text" class="form-control font-monospace text-muted" value="<%= (typeof config !== 'undefined' && config.appUrl ? config.appUrl : '') %>/sync/room/<%= room._id %>.ics" readonly id="icalLink-<%= room._id %>">
                                        <button type="button" class="btn btn-outline-secondary" onclick="copyToClipboard('icalLink-<%= room._id %>')">
                                            <i class="fas fa-copy"></i>
                                        </button>
                                    </div>
                                    <small class="text-muted" style="font-size: 0.7rem;">Paste this link into Airbnb/Agoda's "Import Calendar" setting.</small>
                                </div>
                            </div>
                            <!-- ========================================== -->

                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-light" data-bs-dismiss="modal">Close</button>
                            <button type="submit" class="btn btn-primary fw-bold">Save Changes</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    <% }) %>

    <!-- 9. EDIT USER MODALS -->
    <% users.forEach(u => { %>
        <div class="modal fade" id="editUserModal-<%= u._id.toString() %>" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <form action="/admin/user/update" method="POST">
                        <div class="modal-header bg-dark text-white"><h5 class="modal-title">Edit User</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
                        <div class="modal-body">
                            <input type="hidden" name="userId" value="<%= u._id %>">
                            <div class="row mb-3"><div class="col-6"><label class="small">First Name</label><input type="text" name="firstName" class="form-control" value="<%= u.firstName %>"></div><div class="col-6"><label class="small">Last Name</label><input type="text" name="lastName" class="form-control" value="<%= u.lastName %>"></div></div>
                            <div class="mb-3"><label class="small">Role</label><select name="role" class="form-select"><option value="user" <%= u.role==='user'?'selected':'' %>>Guest</option><option value="staff" <%= u.role==='staff'?'selected':'' %>>Staff</option><option value="manager" <%= u.role==='manager'?'selected':'' %>>Manager</option><option value="admin" <%= u.role==='admin'?'selected':'' %>>Admin</option><% if (user.role === 'superadmin') { %><option value="superadmin" <%= u.role==='superadmin'?'selected':'' %>>Super Admin</option><% } %></select></div>
                            <div class="mb-3"><label class="small">Username/Email</label><% if(u.username) { %><input type="text" name="username" class="form-control" value="<%= u.username %>"><% } else { %><input type="email" name="email" class="form-control" value="<%= u.email %>"><% } %></div>
                            <hr><div class="mb-3"><label class="xs-label text-danger">Reset Password</label><input type="text" name="password" class="form-control" placeholder="New password"></div>
                        </div>
                        <div class="modal-footer"><button type="submit" class="btn btn-primary">Save Changes</button></div>
                    </form>
                </div>
            </div>
        </div>
    <% }) %>

    <!-- 10. MANAGE BOOKING MODALS -->
    <% bookings.forEach(booking => { %>
        <div class="modal fade" id="modal-<%= booking._id.toString() %>" tabindex="-1">
            <div class="modal-dialog modal-xl modal-dialog-scrollable">
                <div class="modal-content">
                    <form action="/admin/booking/update-details" method="POST" enctype="multipart/form-data" style="display: contents;" onsubmit="return validateAdminForm('<%= booking._id %>')">
                        <div class="modal-header bg-primary text-white"><h5 class="modal-title fw-bold">Manage Booking</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
                        <div class="modal-body bg-light">
                            <% if(booking.status === 'pending' && booking.paymentStatus === 'unpaid') { 
                                const oneHour = 60 * 60 * 1000; const createdTime = new Date(booking.createdAt).getTime(); const nowTime = Date.now();
                                let timeLeft = (createdTime + oneHour) - nowTime; if (timeLeft > 90 * 60 * 1000) { timeLeft -= 8 * 60 * 60 * 1000; }
                                const minutesLeft = Math.floor(timeLeft / 60000);
                            %>
                                <div class="alert <%= timeLeft > 0 ? 'alert-warning' : 'alert-danger' %> d-flex align-items-center mb-3 shadow-sm border-0" role="alert">
                                    <i class="fas fa-clock fa-2x me-3"></i>
                                    <div><% if(timeLeft > 0) { %><div class="fw-bold">Payment Pending</div><div class="small">Expires in <strong><%= minutesLeft %> minutes</strong>.</div><% } else { %><div class="fw-bold">Booking Expired</div><% } %></div>
                                </div>
                            <% } %>

                            <input type="hidden" name="bookingId" value="<%= booking._id %>">
                            <input type="hidden" id="category-<%= booking._id %>" value="<%= booking.room ? booking.room.category : 'Studio' %>">
                            <input type="hidden" name="extraFee" id="extraFeeInput-<%= booking._id %>" value="<%= booking.extraFee || 0 %>">
                            <input type="hidden" name="promoApplied" id="inputPromoId-<%= booking._id %>" value="<%= booking.promoApplied ? booking.promoApplied._id : '' %>">
                            <div class="row g-4 h-100">
                                <!-- LEFT: GUEST INFO -->
                                <div class="col-lg-7">
                                    <div class="card mb-3 h-100">
                                        <div class="card-body">
                                            <h6 class="fw-bold text-primary mb-3 text-uppercase small ls-1"><i class="fas fa-user-circle me-2"></i> Primary Guest</h6>
                                            <div class="row g-2 mb-3">
                                                <div class="col-4"><label class="xs-label">First Name</label><input type="text" name="guestFirstName" class="form-control form-control-sm" value="<%= booking.user ? booking.user.firstName : '' %>"></div>
                                                <div class="col-4"><label class="xs-label">Middle</label><input type="text" name="guestMiddleName" class="form-control form-control-sm" value="<%= booking.user ? booking.user.middleName : '' %>"></div>
                                                <div class="col-4"><label class="xs-label">Last Name</label><input type="text" name="guestLastName" class="form-control form-control-sm" value="<%= booking.user ? booking.user.lastName : '' %>"></div>
                                            </div>
                                        <div class="row g-2 mb-3">
                                            <div class="col-6">
                                                <label class="xs-label">Email Address</label>
                                                <input type="email" id="guestEmail-<%= booking._id %>" name="guestEmail" class="form-control form-control-sm" value="<%= booking.user ? booking.user.email : '' %>" required>
                                            </div>
                                            <div class="col-6">
                                                <label class="xs-label">Phone Number</label>
                                                <input type="text" name="guestPhone" class="form-control form-control-sm" value="<%= booking.guestPhone %>" required>
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <label class="xs-label text-success">Update Primary ID</label>
                                            <div class="input-group input-group-sm">
                                                <input type="file" name="primaryIdImage" class="form-control">
                                                <% if(booking.guestIdImage) { %>
                                                    <a href="<%= booking.guestIdImage %>" target="_blank" class="btn btn-secondary">View Current ID</a>
                                                <% } %>
                                            </div>
                                        </div>
                                            <div class="mb-4"><label class="xs-label">Special Requests</label><input type="text" name="specialRequests" class="form-control form-control-sm" value="<%= booking.specialRequests %>"></div>
                                            <div class="d-flex justify-content-between align-items-center mb-3 border-top pt-3">
                                                <h6 class="fw-bold text-primary mb-0 text-uppercase small ls-1"><i class="fas fa-users me-2"></i> Companions</h6>
                                                <button type="button" class="btn btn-sm btn-success rounded-pill px-3" onclick="addAdminCompanion('<%= booking._id %>')"><i class="fas fa-plus me-1"></i> Add Guest</button>
                                            </div>
                                            <div id="adminCompanions-<%= booking._id.toString() %>" class="p-2 bg-light rounded" style="max-height: 300px; overflow-y: auto; min-height: 100px;">
                                                <% if (booking.companions && booking.companions.length > 0) { %>
                                                    <% booking.companions.forEach((comp, index) => { %>
                                                        <div class="companion-card p-3 mb-2 shadow-sm position-relative">
                                                            <div class="row g-2">
                                                                <div class="col-6"><label class="xs-label">Name</label><input type="text" name="compName[]" class="form-control form-control-sm" value="<%= comp.name %>" required></div>
                                                                <div class="col-3"><label class="xs-label">Age</label><input type="number" name="compAge[]" class="form-control form-control-sm" value="<%= comp.age %>" required oninput="updateGuestCount('<%= booking._id %>')"></div>
                                                                <div class="col-3"><label class="xs-label">Gender</label><select name="compGender[]" class="form-select form-select-sm"><option value="Male" <%= comp.gender==='Male'?'selected':'' %>>M</option><option value="Female" <%= comp.gender==='Female'?'selected':'' %>>F</option></select></div>
                                                                <div class="col-6"><label class="xs-label">Contact</label><input type="text" name="compContact[]" class="form-control form-control-sm" value="<%= comp.contact %>"></div>
                                                                <div class="col-6"><label class="xs-label">ID Image</label><input type="file" name="compIdImage_<%= index %>" class="form-control form-control-sm"></div>
                                                            </div>
                                                            <button type="button" class="btn btn-link text-danger position-absolute top-0 end-0 p-2" onclick="removeCompanion(this, '<%= booking._id %>')" title="Remove"><i class="fas fa-times"></i></button>
                                                        </div>
                                                    <% }) %>
                                                <% } else { %> <div class="text-center text-muted py-4 small fst-italic">No companions added yet.</div> <% } %>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- RIGHT: CONFIG & PAYMENT -->
                                <div class="col-lg-5">
                                    <div class="card h-100">
                                        <div class="card-body">
                                            <h6 class="fw-bold text-primary mb-3 text-uppercase small ls-1"><i class="fas fa-sliders-h me-2"></i> Configuration</h6>
                                            <div class="row g-2 mb-3">
                                                <div class="col-8"><label class="xs-label">Assign Room</label><select name="roomId" id="roomSelect-<%= booking._id %>" class="form-select form-select-sm" onchange="initFeeCalculator('<%= booking._id %>')"><% rooms.forEach(r => { %><option value="<%= r._id %>" data-capacity="<%= r.capacity %>" data-price="<%= r.pricePerNight %>" data-category="<%= r.category %>" <%= booking.room && booking.room._id.toString() === r._id.toString() ? 'selected' : '' %>><%= r.name %> (Max: <%= r.capacity %>)</option><% }) %></select></div>
                                                <div class="col-4"><label class="xs-label text-danger">Countable</label><input type="number" name="guests" id="guestCount-<%= booking._id %>" class="form-control form-control-sm border-danger fw-bold text-center" value="<%= booking.guests %>" readonly></div>
                                            </div>
                                            <div class="row g-2 mb-3">
                                                <div class="col-6"><label class="xs-label">Check-in</label><input type="text" name="newCheckIn" id="checkIn-<%= booking._id %>" class="form-control form-control-sm bg-white" value="<%= new Date(booking.checkInDate).toISOString() %>"></div>
                                                <div class="col-6"><label class="xs-label">Check-out</label><input type="text" name="newCheckOut" id="checkOut-<%= booking._id %>" class="form-control form-control-sm bg-white" value="<%= new Date(booking.checkOutDate).toISOString() %>"></div>
                                            </div>
                                            <div class="row g-2 mb-3">
                                                <div class="col-6"><label class="xs-label">Booking Status</label><select name="status" class="form-select form-select-sm"><option value="pending" <%= booking.status==='pending'?'selected':'' %>>Pending</option><option value="confirmed" <%= booking.status==='confirmed'?'selected':'' %>>Confirmed</option><option value="completed" <%= booking.status==='completed'?'selected':'' %>>Completed</option><option value="cancelled" <%= booking.status==='cancelled'?'selected':'' %>>Cancelled</option></select></div>
                                                <div class="col-6"><label class="xs-label">Payment State</label><select name="paymentStatus" class="form-select form-select-sm"><option value="unpaid" <%= booking.paymentStatus==='unpaid'?'selected':'' %>>Unpaid</option><option value="partial" <%= booking.paymentStatus==='partial'?'selected':'' %>>Partial</option><option value="paid" <%= booking.paymentStatus==='paid'?'selected':'' %>>Paid Full</option><option value="refunded" <%= booking.paymentStatus==='refunded'?'selected':'' %>>Refunded</option></select></div>
                                            </div>
                                            <div class="mb-4"><label class="xs-label text-success">Payment Reference</label><input type="text" name="paymentRef" class="form-control form-control-sm border-success" value="<%= booking.paymentRef || '' %>" placeholder="GCash/Bank Ref #"></div>
                                            
                                            <!-- PROMO INPUT -->
                                            <div class="mb-3 border rounded p-2 bg-light">
                                                <label class="xs-label">Apply Promo Code</label>
                                                <div class="input-group input-group-sm">
                                                    <input type="text" id="adminPromoCode-<%= booking._id %>" class="form-control" placeholder="Code" value="<%= booking.promoApplied ? booking.promoApplied.code : '' %>">
                                                    <button type="button" class="btn btn-dark" onclick="applyAdminPromo('<%= booking._id %>')">Apply</button>
                                                </div>
                                                <small id="adminPromoMsg-<%= booking._id %>" class="fw-bold text-success">
                                                    <%= booking.promoApplied ? 'Promo currently applied.' : '' %>
                                                </small>
                                            </div>

                                            <div class="card border-primary mb-2">
                                                <div class="card-header bg-primary text-white py-1"><small class="fw-bold">Payment Breakdown</small></div>
                                                <div class="card-body p-2 bg-white">
                                                    <div class="d-flex justify-content-between align-items-center mb-1"><span class="xs-label text-muted">Room Rate:</span><span class="fw-bold">‚Ç±<span id="basePriceDisplay-<%= booking._id %>">0</span></span></div>
                                                    <div class="d-flex justify-content-between align-items-center mb-2"><span class="xs-label text-danger">Extra Fees:</span><span class="fw-bold text-danger">+ ‚Ç±<span id="feeDisplay-<%= booking._id %>">0</span></span></div>
                                                    <div id="feeText-<%= booking._id %>" class="text-end text-muted fst-italic" style="font-size: 0.7rem; display:none;"></div>
                                                    
                                                    <div class="d-flex justify-content-between align-items-center mb-2 text-success"><span class="xs-label">Discount:</span><span class="fw-bold">- ‚Ç±<span id="discountDisplay-<%= booking._id %>">0</span></span></div>

                                                    <hr class="my-1">
                                            <!-- TOTAL -->
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <span class="fw-bold text-dark">TOTAL:</span>
                                                <div class="input-group input-group-sm w-50">
                                                    <span class="input-group-text px-1">‚Ç±</span>
                                                    <!-- Changed type="text" and added onblur/onfocus handlers -->
                                                    <input type="text" 
                                                           name="newTotalPrice" 
                                                           id="totalPrice-<%= booking._id %>" 
                                                           class="form-control fw-bold text-primary text-end px-1" 
                                                           value="<%= booking.totalPrice.toLocaleString() %>" 
                                                           onfocus="removeCommas(this)" 
                                                           onblur="formatCurrency(this); calculateBalance('<%= booking._id %>')" 
                                                           oninput="calculateBalance('<%= booking._id %>')">
                                                </div>
                                            </div>

                                            <!-- PAID ROW -->
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <span class="xs-label text-success fw-bold">Paid:</span>
                                                
                                                <!-- Container for Input + External Icon -->
                                                <div class="d-flex align-items-center justify-content-end w-50">
                                                    
                                                    <div class="input-group input-group-sm">
                                                        <span class="input-group-text px-1 bg-success text-white">‚Ç±</span>
                                                        <input type="text" 
                                                               name="amountPaid" 
                                                               id="amountPaid-<%= booking._id %>" 
                                                               class="form-control fw-bold text-success text-end px-1" 
                                                               value="<%= (booking.amountPaid || 0).toLocaleString() %>" 
                                                               onfocus="removeCommas(this)" 
                                                               onblur="formatCurrency(this); calculateBalance('<%= booking._id %>')" 
                                                               oninput="calculateBalance('<%= booking._id %>')">
                                                    </div>

                                                    <!-- NEW: External Icon Container -->
                                                    <div id="paidIcon-<%= booking._id %>" class="ms-2" style="width: 20px;">
                                                        <!-- Icon will appear here via JS -->
                                                    </div>

                                                </div>
                                            </div>
                                                    <div class="d-flex justify-content-between align-items-center bg-light p-1 rounded"><span class="xs-label text-danger fw-bold">BALANCE:</span><span class="fw-bold text-danger fs-6">‚Ç±<span id="balanceDisplay-<%= booking._id %>">0</span></span></div>
                                                </div>
                                            </div>
                                            <div class="mb-0"><label class="xs-label">Admin Notes</label><textarea name="adminNotes" class="form-control form-control-sm" rows="2"><%= booking.adminNotes %></textarea></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer bg-white">
                            <button type="button" class="btn btn-light text-muted fw-bold" data-bs-dismiss="modal">Close</button>
                            <button type="submit" class="btn btn-primary fw-bold px-4 shadow-sm"><i class="fas fa-save me-2"></i> Save Changes</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    <% }) %>

    <!-- CALENDAR MODAL -->
    <div class="modal fade" id="calendarModal" tabindex="-1"><div class="modal-dialog modal-fullscreen"><div class="modal-content"><div class="modal-header bg-dark text-white"><h5 class="modal-title">Calendar</h5><button class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body p-0"><div id='adminCalendar' style="height:100%"></div></div></div></div></div>

<!-- MAINTENANCE MODAL -->
<div class="modal fade" id="maintenanceModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title fw-bold"><i class="fas fa-tools me-2"></i> Maintenance Tracker</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <!-- LEFT: FORM -->
                    <div class="col-md-4 border-end">
                        <h6 class="fw-bold mb-3 text-danger">Add New Task</h6>
                        <form action="/admin/maintenance/create" method="POST">
                            <div class="mb-3">
                                <label class="xs-label">Room</label>
                                <select name="roomId" class="form-select" required>
                                    <% rooms.forEach(r => { %>
                                        <option value="<%= r._id %>"><%= r.name %></option>
                                    <% }) %>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="xs-label">Task / Issue</label>
                                <input type="text" name="task" class="form-control" placeholder="e.g. Repainting, AC Repair" required>
                            </div>
                            <div class="row g-2 mb-3">
                                <div class="col-6">
                                    <label class="xs-label">Start Date</label>
                                    <input type="date" name="startDate" class="form-control" required>
                                </div>
                                <div class="col-6">
                                    <label class="xs-label">Finish Date (Est)</label>
                                    <input type="date" name="endDate" class="form-control">
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="xs-label">Status</label>
                                <select name="status" class="form-select">
                                    <option value="Scheduled">Scheduled</option>
                                    <option value="In Progress">In Progress</option>
                                    <option value="Completed">Completed</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="xs-label">Notes</label>
                                <textarea name="notes" class="form-control" rows="3"></textarea>
                            </div>
                            <button type="submit" class="btn btn-danger w-100 fw-bold">Add Task</button>
                        </form>
                    </div>

                    <!-- RIGHT: LIST -->
                    <div class="col-md-8">
                        <h6 class="fw-bold mb-3">Active Maintenance</h6>
                        <div class="table-responsive card shadow-sm">
                            <table class="table table-hover align-middle mb-0 small">
                                <thead class="bg-light">
                                    <tr>
                                        <th>Room</th>
                                        <th>Task</th>
                                        <th>Dates</th>
                                        <th>Status</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <% if(typeof maintenanceRecords !== 'undefined' && maintenanceRecords.length > 0) { %>
                                        <% maintenanceRecords.forEach(m => { %>
                                            <tr>
                                                <td class="fw-bold"><%= m.room ? m.room.name : 'Unknown' %></td>
                                                <td><%= m.task %></td>
                                                <td>
                                                    <div>Start: <%= new Date(m.startDate).toLocaleDateString() %></div>
                                                    <% if(m.endDate) { %>
                                                        <div class="text-muted">End: <%= new Date(m.endDate).toLocaleDateString() %></div>
                                                    <% } %>
                                                </td>
                                                <td>
                                                    <% 
                                                        let badge = 'bg-secondary';
                                                        if(m.status === 'In Progress') badge = 'bg-warning text-dark';
                                                        if(m.status === 'Completed') badge = 'bg-success';
                                                    %>
                                                    <span class="badge <%= badge %>"><%= m.status %></span>
                                                </td>
                                                <td>
                                                    <button class="btn btn-sm btn-light border" data-bs-toggle="modal" data-bs-target="#editMaint-<%= m._id %>"><i class="fas fa-edit"></i></button>
                                                    <a href="/admin/maintenance/delete/<%= m._id %>" class="btn btn-sm btn-light border text-danger" onclick="return confirm('Delete record?')"><i class="fas fa-trash"></i></a>
                                                </td>
                                            </tr>
                                        <% }) %>
                                    <% } else { %>
                                        <tr><td colspan="5" class="text-center text-muted py-4">No maintenance records found.</td></tr>
                                    <% } %>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- EDIT MAINTENANCE MODALS (Generated for each record) -->
<% if(typeof maintenanceRecords !== 'undefined') { %>
    <% maintenanceRecords.forEach(m => { %>
        <div class="modal fade" id="editMaint-<%= m._id %>" tabindex="-1" style="z-index: 1060;">
            <div class="modal-dialog">
                <div class="modal-content">
                    <form action="/admin/maintenance/update" method="POST">
                        <div class="modal-header bg-dark text-white">
                            <h5 class="modal-title">Edit Task: <%= m.task %></h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <input type="hidden" name="maintenanceId" value="<%= m._id %>">
                            <div class="mb-3">
                                <label class="xs-label">Task Name</label>
                                <input type="text" name="task" class="form-control" value="<%= m.task %>" required>
                            </div>
                            <div class="row g-2 mb-3">
                                <div class="col-6">
                                    <label class="xs-label">Start Date</label>
                                    <input type="date" name="startDate" class="form-control" value="<%= new Date(m.startDate).toISOString().split('T')[0] %>" required>
                                </div>
                                <div class="col-6">
                                    <label class="xs-label">End Date</label>
                                    <input type="date" name="endDate" class="form-control" value="<%= m.endDate ? new Date(m.endDate).toISOString().split('T')[0] : '' %>">
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="xs-label">Status</label>
                                <select name="status" class="form-select">
                                    <option value="Scheduled" <%= m.status === 'Scheduled' ? 'selected' : '' %>>Scheduled</option>
                                    <option value="In Progress" <%= m.status === 'In Progress' ? 'selected' : '' %>>In Progress</option>
                                    <option value="Completed" <%= m.status === 'Completed' ? 'selected' : '' %>>Completed</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="xs-label">Notes</label>
                                <textarea name="notes" class="form-control" rows="3"><%= m.notes %></textarea>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#maintenanceModal">Back</button>
                            <button type="submit" class="btn btn-primary">Save Changes</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    <% }) %>
<% } %>

<!-- REVIEW MODERATION MODAL -->
<div class="modal fade" id="reviewModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title fw-bold"><i class="fas fa-star me-2"></i> Pending Reviews</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <% if(typeof pendingReviews !== 'undefined' && pendingReviews.length > 0) { %>
                    <div class="list-group">
                        <% pendingReviews.forEach(r => { %>
                            <div class="list-group-item p-3">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <h6 class="fw-bold mb-1"><%= r.user.firstName %> <%= r.user.lastName %></h6>
                                        <div class="text-warning small mb-2">
                                            <% for(let i=0; i<r.rating; i++) { %><i class="fas fa-star"></i><% } %>
                                        </div>
                                        <p class="mb-1 fst-italic">"<%= r.comment %>"</p>
                                        <small class="text-muted">Room: <%= r.booking && r.booking.room ? r.booking.room : 'Unknown' %></small>
                                    </div>
                                    <div class="d-flex gap-2">
                                        <a href="/admin/review/approve/<%= r._id %>" class="btn btn-success btn-sm"><i class="fas fa-check"></i> Approve</a>
                                        <a href="/admin/review/reject/<%= r._id %>" class="btn btn-danger btn-sm" onclick="return confirm('Delete this review?')"><i class="fas fa-times"></i> Reject</a>
                                    </div>
                                </div>
                            </div>
                        <% }) %>
                    </div>
                <% } else { %>
                    <div class="text-center py-5 text-muted">
                        <i class="fas fa-check-circle fa-3x mb-3 text-success opacity-50"></i>
                        <p>All reviews moderated.</p>
                    </div>
                <% } %>
            </div>
        </div>
    </div>
</div>
<!-- SCRIPTS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script>
        // State management for each booking modal
        const bookingState = {};

        // --- FORMATTING HELPERS ---
        function formatCurrency(input) {
            let val = input.value.replace(/,/g, '');
            if (!val) return;
            input.value = parseFloat(val).toLocaleString();
        }

        function removeCommas(input) {
            input.value = input.value.replace(/,/g, '');
        }

        document.addEventListener('DOMContentLoaded', function() {
            // 1. Initialize Global Pickers
            if(document.querySelector("#eligibleDatesInput")) { flatpickr("#eligibleDatesInput", { mode: "multiple", dateFormat: "Y-m-d", minDate: "today" }); }
            if(document.getElementById("filterDateRange")) { flatpickr("#filterDateRange", { mode: "range", dateFormat: "Y-m-d", maxDate: "today" }); }
            if(document.getElementById("reportDateRange")) { flatpickr("#reportDateRange", { mode: "range", dateFormat: "Y-m-d", defaultDate: [new Date().setDate(new Date().getDate() - 30), new Date()] }); }
            
            // 2. Initialize Calendar
            var calendarEl = document.getElementById('adminCalendar');
            if (calendarEl) {
                var calendarModal = document.getElementById('calendarModal');
                var calendarInstance = null;
                calendarModal.addEventListener('shown.bs.modal', function () {
                    if (!calendarInstance) {
                        calendarInstance = new FullCalendar.Calendar(calendarEl, {
                            initialView: 'dayGridMonth', height: '100%', 
                            headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,timeGridWeek,listWeek' },
                            events: '/api/v1/admin/calendar-events',
                            eventTimeFormat: { hour: '2-digit', minute: '2-digit', meridiem: false },
                            eventClick: function(info) { if (info.event.url) { window.location.href = info.event.url; info.jsEvent.preventDefault(); } }
                        });
                        calendarInstance.render();
                    } else { calendarInstance.updateSize(); calendarInstance.refetchEvents(); }
                });
            }
            <% if (typeof promotions !== 'undefined') { %>
                <% promotions.forEach(p => { %>
                    flatpickr("#editDates-<%= p._id %>", { 
                        mode: "multiple", 
                        dateFormat: "Y-m-d", 
                        minDate: "today",
                        defaultDate: <%- JSON.stringify(p.eligibleDates) %> 
                    });
                <% }) %>
            <% } %>
            // 3. Initialize Booking Modals
            document.querySelectorAll('[id^="modal-"]').forEach(modal => {
                const bookingId = modal.id.split('-')[1];
                
                // Initialize State
                bookingState[bookingId] = {
                    isB1T1Applied: false,
                    originalCheckOutDate: null,
                    fpOut: null,
                    fpIn: null
                };

                const checkInEl = document.getElementById(`checkIn-${bookingId}`);
                const checkOutEl = document.getElementById(`checkOut-${bookingId}`);
                
                // --- FLAT PICKER CONFIG ---
                if (checkInEl && checkOutEl) {
                    const fpConfig = { 
                        enableTime: true, 
                        dateFormat: "Y-m-d H:i", 
                        onClose: function(selectedDates, dateStr, instance) {
                            // When date changes manually, check if we need to re-validate promo
                            const code = document.getElementById(`adminPromoCode-${bookingId}`).value;
                            if (code) {
                                // Re-apply promo logic but SKIP auto-extension (respect user's manual date)
                                applyAdminPromo(bookingId, true); 
                            } else {
                                runFullCalculation(bookingId);
                            }
                        }
                    };
                    
                    bookingState[bookingId].fpOut = flatpickr(checkOutEl, fpConfig);
                    bookingState[bookingId].fpIn = flatpickr(checkInEl, {
                        ...fpConfig,
                        onChange: function(selectedDates, dateStr, instance) {
                            if (selectedDates.length > 0) {
                                // Reset B1T1 state if checkin changes
                                bookingState[bookingId].isB1T1Applied = false;
                                bookingState[bookingId].originalCheckOutDate = null;
                                
                                // Default logic: set checkout to next day 11am if checkin moves past checkout
                                const checkInDate = selectedDates[0];
                                const currentOut = bookingState[bookingId].fpOut.selectedDates[0];
                                
                                if (!currentOut || checkInDate >= currentOut) {
                                    const nextDay = new Date(checkInDate);
                                    nextDay.setDate(nextDay.getDate() + 1);
                                    nextDay.setHours(11, 0, 0, 0);
                                    bookingState[bookingId].fpOut.setDate(nextDay);
                                }
                            }
                        }
                    });
                }

                // --- INITIALIZE DATA ON LOAD ---
                updateGuestCount(bookingId); 
                
                // --- AUTO-APPLY PROMO IF EXISTS ---
                const promoInput = document.getElementById(`adminPromoCode-${bookingId}`);
                if(promoInput && promoInput.value) {
                    // If a code is pre-filled, validate it immediately to show discount
                    // Pass 'true' to skip auto-extension since dates are already saved
                    applyAdminPromo(bookingId, true);
                } else {
                    runFullCalculation(bookingId);
                }

                // --- INPUT LISTENER FOR PROMO CODE ---
                if(promoInput) {
                    promoInput.addEventListener('input', function() {
                        const state = bookingState[bookingId];
                        
                        // If user types, we reset the "Applied" state so they can apply again
                        state.isB1T1Applied = false;
                        
                        // Clear displayed discount visually until Apply is clicked
                        const discountEl = document.getElementById(`discountDisplay-${bookingId}`);
                        if(discountEl) discountEl.innerText = '0';
                        
                        // Clear message
                        const msgEl = document.getElementById(`adminPromoMsg-${bookingId}`);
                        if(msgEl) msgEl.innerHTML = '';

                        // Recalculate Fees (Base Price)
                        runFullCalculation(bookingId);
                    });
                }
            });
        });

        // --- CORE CALCULATION FUNCTIONS ---

        function runFullCalculation(id) {
            const financials = calculateAdminFees(id); 
            
            // However, we need to preserve the discount if it wasn't cleared.
            // Let's check the display value
            const discountDisplay = document.getElementById(`discountDisplay-${id}`);
            let currentDiscount = 0;
            if(discountDisplay) {
                currentDiscount = parseFloat(discountDisplay.innerText.replace(/,/g, '')) || 0;
            }
            
            // Update Total Input
            const newTotal = (financials.basePrice + financials.extraFee) - currentDiscount;
            const totalInput = document.getElementById(`totalPrice-${id}`);
            if(totalInput) totalInput.value = newTotal.toLocaleString(); // Format with commas

            calculateBalance(id);
        }

        function calculateAdminFees(id) {
            const checkInEl = document.getElementById(`checkIn-${id}`);
            const checkOutEl = document.getElementById(`checkOut-${id}`);
            const basePriceDisplay = document.getElementById(`basePriceDisplay-${id}`);
            const feeDisplay = document.getElementById(`feeDisplay-${id}`);
            const feeTextEl = document.getElementById(`feeText-${id}`);
            const feeInput = document.getElementById(`extraFeeInput-${id}`);
            const roomSelect = document.getElementById(`roomSelect-${id}`);
            
            if(!roomSelect) return { basePrice: 0, extraFee: 0 };

            const selectedOption = roomSelect.options[roomSelect.selectedIndex];
            const pricePerNight = parseFloat(selectedOption.getAttribute('data-price')); 
            const category = selectedOption.getAttribute('data-category');
            
            let inDate, outDate;
            if (bookingState[id] && bookingState[id].fpIn && bookingState[id].fpIn.selectedDates[0]) {
                inDate = bookingState[id].fpIn.selectedDates[0];
            } else { inDate = new Date(checkInEl.value); }

            if (bookingState[id] && bookingState[id].fpOut && bookingState[id].fpOut.selectedDates[0]) {
                outDate = bookingState[id].fpOut.selectedDates[0];
            } else { outDate = new Date(checkOutEl.value); }
            
            if(isNaN(inDate) || isNaN(outDate)) return { basePrice: 0, extraFee: 0 };
            
            // Calculate Nights
            const diffTime = Math.abs(outDate - inDate); 
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
            const basePrice = diffDays * pricePerNight;
            
            // Calculate Fees
            const rateSmall = <%= config.feeSmallRoom || 500 %>; 
            const rateLarge = <%= config.feeLargeRoom || 1000 %>;
            let hourlyRate = (['Studio', '1BR'].includes(category)) ? rateSmall : rateLarge;
            let extraFee = 0; let reasons = [];
            
            if (inDate.getHours() < 14) { 
                const hrs = 14 - inDate.getHours(); 
                extraFee += hrs * hourlyRate; 
                reasons.push(`Early In (${hrs}h)`); 
            }
            
            let lateHrs = 0; 
            if (outDate.getHours() > 11) { lateHrs = outDate.getHours() - 11; } 
            else if (outDate.getHours() === 11 && outDate.getMinutes() > 0) { lateHrs = 1; }
            
            if (lateHrs > 0) { 
                extraFee += lateHrs * hourlyRate; 
                reasons.push(`Late Out (${lateHrs}h)`); 
            }
            
            // Update UI
            if(basePriceDisplay) basePriceDisplay.innerText = basePrice.toLocaleString();
            if(feeDisplay) feeDisplay.innerText = extraFee.toLocaleString();
            if(feeInput) feeInput.value = extraFee; 
            
            if (extraFee > 0) { 
                feeTextEl.style.display = 'block'; 
                feeTextEl.innerText = `$${reasons.join(', ')} @ ‚Ç±$${hourlyRate}/hr`; 
            } else { 
                feeTextEl.style.display = 'none'; 
            }

            return { basePrice, extraFee };
        }

        function calculateBalance(id) {
            const totalInput = document.getElementById(`totalPrice-${id}`); 
            const paidInput = document.getElementById(`amountPaid-${id}`);
            const balanceDisplay = document.getElementById(`balanceDisplay-${id}`);
            const iconContainer = document.getElementById(`paidIcon-${id}`); // Get new container
            
            // Remove commas before parsing
            const total = parseFloat(totalInput.value.replace(/,/g, '')) || 0; 
            const paid = parseFloat(paidInput.value.replace(/,/g, '')) || 0;
            
            const balance = total - paid;
            
            if(balanceDisplay) balanceDisplay.innerText = balance.toLocaleString();
            
            // VALIDATION LOGIC
            if (paid > 0 && paid < (total * 0.5)) { 
                // INVALID STATE
                paidInput.classList.add('is-invalid'); 
                paidInput.classList.remove('is-valid'); 
                // Set External Icon (Red X)
                if(iconContainer) iconContainer.innerHTML = '<i class="fas fa-times-circle text-danger"></i>';
            } else { 
                paidInput.classList.remove('is-invalid'); 
                
                if(paid > 0) {
                    // VALID STATE
                    paidInput.classList.add('is-valid'); 
                    // Set External Icon (Green Check)
                    if(iconContainer) iconContainer.innerHTML = '<i class="fas fa-check-circle text-success"></i>';
                } else {
                    // NEUTRAL STATE (0 paid)
                    paidInput.classList.remove('is-valid'); 
                    if(iconContainer) iconContainer.innerHTML = ''; // Clear icon
                }
            }
        }

        function updateGuestCount(bookingId) {
            const container = document.getElementById(`adminCompanions-${bookingId}`);
            const guestInput = document.getElementById(`guestCount-${bookingId}`);
            if(container && guestInput) {
                let total = 1; 
                const ageInputs = container.querySelectorAll('input[name="compAge[]"]');
                ageInputs.forEach(input => { const age = parseInt(input.value) || 0; if (age >= 2) { total++; } });
                guestInput.value = total;
            }
        }

        function validateAdminForm(id) {
            const total = parseFloat(document.getElementById(`totalPrice-${id}`).value.replace(/,/g, '')) || 0; 
            const paid = parseFloat(document.getElementById(`amountPaid-${id}`).value.replace(/,/g, '')) || 0;
            
            // Unformat values before submit
            document.getElementById(`totalPrice-${id}`).value = total;
            document.getElementById(`amountPaid-${id}`).value = paid;

            if (paid > 0 && paid < total && paid < (total * 0.5)) { 
                alert(`Invalid Payment Amount!\n\nPartial payments must be at least 50% of the total price (‚Ç±${(total * 0.5).toLocaleString()}).`); 
                return false; 
            }
            return true;
        }

        function addAdminCompanion(bookingId) {
            const container = document.getElementById(`adminCompanions-${bookingId}`);
            const nextIndex = container.children.length + "_" + Date.now(); 
            const div = document.createElement('div');
            div.className = 'companion-card p-3 mb-2 shadow-sm position-relative';
            div.innerHTML = `<div class="row g-2"><div class="col-6"><label class="xs-label">Name</label><input type="text" name="compName[]" class="form-control form-control-sm" required></div><div class="col-3"><label class="xs-label">Age</label><input type="number" name="compAge[]" class="form-control form-control-sm" required oninput="updateGuestCount('$${bookingId}')"></div><div class="col-3"><label class="xs-label">Gender</label><select name="compGender[]" class="form-select form-select-sm"><option value="Male">M</option><option value="Female">F</option></select></div><div class="col-6"><label class="xs-label">Contact</label><input type="text" name="compContact[]" class="form-control form-control-sm"></div><div class="col-6"><label class="xs-label">Upload ID</label><input type="file" name="compIdImage_$$${nextIndex}" class="form-control form-control-sm"></div></div><button type="button" class="btn btn-link text-danger position-absolute top-0 end-0 p-2" onclick="removeCompanion(this, '$${bookingId}')" title="Remove"><i class="fas fa-times"></i></button>`;
            container.appendChild(div); updateGuestCount(bookingId);
        }
        
        function removeCompanion(btn, bookingId) { btn.closest('.companion-card').remove(); updateGuestCount(bookingId); }

        function initFeeCalculator(id) { runFullCalculation(id); }

        // --- PROMO APPLICATION ---
                window.applyAdminPromo = async function(id, isDateChange = false) {
            const code = document.getElementById(`adminPromoCode-${id}`).value;
            const msgEl = document.getElementById(`adminPromoMsg-${id}`);
            const roomId = document.getElementById(`roomSelect-${id}`).value;
            const roomSelect = document.getElementById(`roomSelect-${id}`);
            const pricePerNight = parseFloat(roomSelect.options[roomSelect.selectedIndex].getAttribute('data-price'));
            
            // --- FIX: ROBUST EMAIL FETCHING ---
            // 1. Find the specific modal for this booking
            const modal = document.getElementById(`modal-${id}`);
            
            // 2. Find the email input inside THAT modal by its name attribute
            const emailInput = modal.querySelector('input[name="guestEmail"]');
            const email = emailInput ? emailInput.value.trim() : '';

            console.log("Applying Promo for Booking:", id);
            console.log("Email Found:", email); // Check your browser console (F12) to confirm
            // ----------------------------------

            // 3. Get Current Dates
            let checkInVal, checkOutVal;
            if (bookingState[id].fpIn && bookingState[id].fpIn.selectedDates[0]) {
                checkInVal = bookingState[id].fpIn.selectedDates[0];
            } else { checkInVal = new Date(document.getElementById(`checkIn-${id}`).value); }

            if (bookingState[id].fpOut && bookingState[id].fpOut.selectedDates[0]) {
                checkOutVal = bookingState[id].fpOut.selectedDates[0];
            } else { checkOutVal = new Date(document.getElementById(`checkOut-${id}`).value); }

            // 4. Calculate Nights
            const diffTime = Math.abs(checkOutVal - checkInVal); 
            const nights = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            const basePrice = nights * pricePerNight;

            const state = bookingState[id];

            try {
                // 5. Call Backend Validation
                const response = await fetch('/promo/validate', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        code, 
                        roomId, 
                        totalAmount: basePrice, 
                        checkInDate: checkInVal, 
                        pricePerNight: pricePerNight, 
                        nights: nights,
                        email: email, // <--- Sending the email we found above
                        bookingId: id // <--- Sending ID to exclude current booking from "already used" check
                    })
                });
                const data = await response.json();
                
                if (data.success) {
                    msgEl.innerHTML = `<span class="text-success small">${data.message}</span>`;
                    
                    const hiddenIdInput = document.getElementById(`inputPromoId-${id}`);
                    if(hiddenIdInput) hiddenIdInput.value = data.promoId;

                    // Auto-Extension Logic
                    if (data.action === 'extend' || (data.message.includes("B1T1") && nights === 1)) {
                        if (!state.isB1T1Applied || isDateChange) {
                            const newOutDate = new Date(checkOutVal); 
                            newOutDate.setDate(newOutDate.getDate() + 1);
                            
                            if(state.fpOut) {
                                state.fpOut.setDate(newOutDate);
                            } else {
                                document.getElementById(`checkOut-${id}`).value = newOutDate.toISOString().slice(0,16);
                            }
                            
                            state.isB1T1Applied = true;
                            msgEl.innerHTML = `<span class="text-primary small fw-bold"><i class="fas fa-magic me-1"></i> B1T1 Applied: Auto-extended to 2 nights!</span>`;
                            setTimeout(() => applyAdminPromo(id, false), 100); 
                            return; 
                        } 
                    } 

                    const discountDisplay = document.getElementById(`discountDisplay-${id}`);
                    if(discountDisplay) discountDisplay.innerText = data.discountAmount.toLocaleString();
                    
                    const currentFees = calculateAdminFees(id);
                    const newTotal = (currentFees.basePrice + currentFees.extraFee) - data.discountAmount;
                    
                    const totalInput = document.getElementById(`totalPrice-${id}`);
                    if(totalInput) totalInput.value = newTotal.toLocaleString();
                    
                    calculateBalance(id);

                } else {
                    // Promo Invalid
                    msgEl.innerHTML = `<span class="text-danger small">${data.message}</span>`;
                    document.getElementById(`discountDisplay-${id}`).innerText = "0";
                    const hiddenIdInput = document.getElementById(`inputPromoId-${id}`);
                    if(hiddenIdInput) hiddenIdInput.value = '';
                    runFullCalculation(id); 
                }
            } catch (err) { console.error(err); msgEl.innerText = "Error validating promo"; }
        }

        // --- NEW: COPY TO CLIPBOARD HELPER ---
        function copyToClipboard(elementId) {
            var copyText = document.getElementById(elementId);
            copyText.select();
            copyText.setSelectionRange(0, 99999); // For mobile devices
            navigator.clipboard.writeText(copyText.value).then(() => {
                alert("Link copied: " + copyText.value);
            });
        }
    </script>
</body>
</html>